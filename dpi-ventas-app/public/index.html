<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DPI Publicidad - Sistema de Ventas Railway</title>
    <style>
        :root {
            --primary-color: #0FA795; --secondary-color: #8BC34A; --danger-color: #dc3545;
            --warning-color: #ffc107; --info-color: #17a2b8; --success-color: #28a745;
            --dark-color: #343a40; --light-color: #f8f9fa; --white-color: #ffffff; --border-color: #dee2e6;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Arial', sans-serif; background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%); min-height: 100vh; padding: 15px; font-size: 14px; }
        .container { max-width: 1600px; margin: 0 auto; transition: filter 0.3s ease; }
        .header { text-align: center; color: var(--white-color); margin-bottom: 20px; }
        .header h1 { font-size: 2.2em; margin-bottom: 5px; text-shadow: 2px 2px 4px rgba(0,0,0,0.3); }
        .header .status { background: rgba(255,255,255,0.2); padding: 8px 15px; border-radius: 20px; font-size: 0.9em; margin-top: 10px; display: inline-block; transition: all 0.3s ease; }
        .header .status.online { background: var(--success-color); }
        .header .status.offline { background: var(--danger-color); }
        .mode-switcher { text-align: center; margin-bottom: 20px; }
        .mode-btn { background: var(--white-color); color: var(--primary-color); border: none; padding: 12px 25px; margin: 0 10px; border-radius: 25px; font-weight: bold; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 4px 15px rgba(0,0,0,0.2); }
        .mode-btn.active, .mode-btn:hover { background: var(--dark-color); color: var(--white-color); transform: translateY(-2px); }
        .panel { background: var(--white-color); border-radius: 12px; padding: 20px; box-shadow: 0 8px 25px rgba(0,0,0,0.15); margin-bottom: 20px; }
        .panel h2 { color: #333; margin-bottom: 15px; font-size: 1.3em; border-bottom: 3px solid var(--primary-color); padding-bottom: 8px; }
        .loading, .empty-state { text-align: center; padding: 40px 20px; color: #666; }
        .loading::after { content: ''; display: inline-block; width: 20px; height: 20px; border: 3px solid #f3f3f3; border-top: 3px solid var(--primary-color); border-radius: 50%; animation: spin 1s linear infinite; margin-left: 10px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .error-message { background: #f8d7da; color: #721c24; padding: 15px; border-radius: 8px; text-align: center; }
        .ventas-mode { display: block; }
        .search-container { padding: 0 0 15px 0; }
        .search-box { position: relative; }
        .search-input { width: 100%; padding: 12px 45px 12px 15px; border: 2px solid var(--border-color); border-radius: 25px; font-size: 14px; }
        .search-input:focus { outline: none; border-color: var(--primary-color); }
        .search-results { position: absolute; top: 105%; left: 0; right: 0; background: var(--white-color); border: 1px solid var(--border-color); border-radius: 8px; max-height: 400px; overflow-y: auto; z-index: 200; display: none; }
        .search-results.active { display: block; }
        .search-result-item { padding: 12px 15px; border-bottom: 1px solid #f1f3f4; cursor: pointer; }
        .search-result-item:hover { background: var(--light-color); }
        mark { background: #fff3cd; }
        .semaforo { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .semaforo-item { text-align: center; padding: 15px; border-radius: 10px; font-weight: bold; }
        .semaforo-item h3 { margin-bottom: 10px; }
        .semaforo-item p { font-size: 0.9em; font-weight: normal; margin-bottom: 15px; font-style: italic; opacity: 0.9; }
        .semaforo-item ul { text-align: left; list-style: none; padding-left: 5px; font-size: 0.9em; font-weight: normal; }
        .semaforo-item li { margin-bottom: 5px; }
        .verde { background: linear-gradient(135deg, #28a745, #20c997); color: white; }
        .amarillo { background: linear-gradient(135deg, #ffc107, #fd7e14); color: #333; }
        .rojo { background: linear-gradient(135deg, #dc3545, #e74c3c); color: white; }
        .tabs { display: flex; background: var(--light-color); border-radius: 12px 12px 0 0; }
        .tab { flex: 1; padding: 12px 15px; background: var(--light-color); border: none; cursor: pointer; font-weight: bold; }
        .tab.active { background: var(--primary-color); color: var(--white-color); }
        .tab-content { background: var(--white-color); padding: 20px; border-radius: 0 0 12px 12px; min-height: 400px; max-height: 600px; overflow-y: auto; }
        .script-card { background: var(--light-color); border-radius: 8px; padding: 15px; margin-bottom: 15px; border-left: 4px solid var(--primary-color); }
        .script-title { font-weight: bold; display: flex; justify-content: space-between; align-items: center; }
        .script-text { background: var(--white-color); padding: 12px; border-radius: 6px; white-space: pre-line; margin: 10px 0; }
        .script-badge { padding: 3px 8px; border-radius: 10px; font-size: 0.7em; color: var(--white-color); }
        .usage-stats { display: flex; gap: 15px; font-size: 0.8em; color: #6c757d; margin-top: 10px; }
        .copy-btn { background: var(--secondary-color); color: var(--white-color); border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer; }
        .copy-btn.copied { background: var(--success-color); }
        .admin-mode { display: none; }
        .admin-mode.visible { display: block; }
        .stats-bar { display: flex; justify-content: space-around; background: var(--dark-color); color: white; padding: 15px; border-radius: 8px; margin-bottom: 20px; }
        .stats-item { text-align: center; }
        .stats-number { font-size: 1.8em; font-weight: bold; }
        .stats-label { font-size: 0.9em; }
        .admin-controls { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .form-group label { display: block; font-weight: bold; margin-bottom: 5px; }
        .form-group select, .form-group input, .form-group textarea { width: 100%; padding: 10px; border: 2px solid var(--border-color); border-radius: 6px; }
        .form-group textarea { height: 120px; resize: vertical; }
        .admin-btn { background: var(--primary-color); color: var(--white-color); border: none; padding: 12px 20px; border-radius: 6px; cursor: pointer; font-weight: bold; margin: 5px; }
        .admin-btn.danger { background: var(--danger-color); }
        .admin-btn.success { background: var(--success-color); }
        .scripts-list { max-height: 450px; overflow-y: auto; }
        .script-item { background: var(--light-color); border: 1px solid var(--border-color); border-radius: 6px; padding: 15px; margin-bottom: 10px; }
        .script-item h4 { color: var(--primary-color); }
        .script-item-actions { margin-top: 10px; }
        .script-item-actions button { border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; margin-right: 5px; }
        .edit-btn { background: var(--info-color); color: var(--white-color); }
        .delete-btn { background: var(--danger-color); color: var(--white-color); }
        .auth-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 9999; display: none; justify-content: center; align-items: center; }
        .auth-overlay.active { display: flex; }
        .auth-modal { background: var(--white-color); border-radius: 12px; padding: 30px; width: 90%; max-width: 400px; text-align: center; }
        .auth-error { background: #f8d7da; color: #721c24; padding: 10px; border-radius: 8px; margin-bottom: 15px; display: none; }
        .auth-input { width: 100%; padding: 12px; margin-bottom: 10px; border: 1px solid var(--border-color); border-radius: 6px; }
        .connection-status { position: fixed; bottom: 10px; right: 10px; padding: 8px 15px; border-radius: 20px; z-index: 1000; }
        .connection-status.online { background: #d4edda; color: #155724; }
        .connection-status.offline { background: #f8d7da; color: #721c24; }
        .hidden { display: none; }
        .alert { padding: 12px; border-radius: 6px; margin-bottom: 15px; font-weight: bold; }
        .alert.success { background: #d4edda; color: #155724; }
        .alert.error { background: #f8d7da; color: #721c24; }
    </style>
</head>
<body>
    <div id="connectionStatus" class="connection-status offline">üî¥ Conectando...</div>
    <div class="auth-overlay" id="authOverlay">
        <div class="auth-modal">
            <h2>üîê Acceso Administrativo</h2>
            <p>Ingresa tus credenciales para continuar</p>
            <div id="authError" class="auth-error">Usuario o Contrase√±a incorrectos</div>
            <form id="authForm" style="margin-top: 20px;">
                <input type="text" id="authUsername" class="auth-input" placeholder="Usuario" required>
                <input type="password" id="authPassword" class="auth-input" placeholder="Contrase√±a" required>
                <button type="submit" class="admin-btn success">Ingresar</button>
                <button type="button" class="admin-btn danger" onclick="cancelAuth()">Cancelar</button>
            </form>
        </div>
    </div>
    <div class="container" id="mainContent">
        <div class="header">
            <h1>üéØ DPI Publicidad - Sistema Railway</h1>
            <p>Rotulos ‚Ä¢ Material POP ‚Ä¢ Stands ‚Ä¢ Banners ‚Ä¢ Viniles</p>
            <div class="status" id="systemStatus">Conectando al servidor...</div>
        </div>
        <div class="mode-switcher">
            <button class="mode-btn active" onclick="switchMode('ventas')">üì± Modo Ventas</button>
            <button class="mode-btn" onclick="switchMode('admin')">‚öôÔ∏è Modo Admin</button>
        </div>
        <div class="ventas-mode" id="ventasMode">
            <div class="panel">
                <h2>üö¶ SEM√ÅFORO DE CALIFICACI√ìN</h2>
                 <div class="semaforo">
                    <div class="semaforo-item verde"><h3>üü¢ LUZ VERDE: COTIZAR</h3><p>El cliente se siente escuchado, conf√≠a en nosotros y entiende el valor.</p><ul><li>‚úì Entendimos su "porqu√©".</li><li>‚úì Validamos su presupuesto.</li><li>‚úì Confirm√≥ que le gusta la idea.</li><li>‚úì El decisor est√° involucrado.</li></ul></div>
                    <div class="semaforo-item amarillo"><h3>üü° LUZ AMARILLA: INVESTIGAR</h3><p>A√∫n no entendemos la necesidad real. Es momento de preguntar, no de proponer.</p><ul><li>! Habla solo de precio.</li><li>! No tiene claro el objetivo.</li><li>! Pide "ideas" sin contexto.</li><li>! No es el decisor final.</li></ul></div>
                    <div class="semaforo-item rojo"><h3>üî¥ LUZ ROJA: PAUSAR</h3><p>Riesgo alto de ser una "cotizaci√≥n fantasma". Invertir tiempo aqu√≠ es costoso.</p><ul><li>‚Ä¢ "Solo para tener una idea".</li><li>‚Ä¢ Sin presupuesto ni urgencia.</li><li>‚Ä¢ No responde preguntas clave.</li><li>‚Ä¢ "Env√≠eme lo que tengas".</li></ul></div>
                </div>
            </div>
            <div class="panel">
                <div class="search-container">
                    <div class="search-box">
                        <input type="text" class="search-input" id="searchInput" placeholder="üîç Buscar scripts..." autocomplete="off">
                        <div class="search-results" id="searchResults"></div>
                    </div>
                </div>
            </div>
            <div class="panel">
                <div class="tabs" id="categoryTabs"></div>
                <div class="tab-content" id="scriptsContainer"><div class="loading"></div></div>
            </div>
        </div>
        <div class="admin-mode" id="adminMode">
             <div class="panel stats-bar" id="statsBar">
                <div class="stats-item"><span id="totalScripts" class="stats-number">-</span><span class="stats-label">Scripts Totales</span></div>
                <div class="stats-item"><span id="lastUpdate" class="stats-number">-</span><span class="stats-label">√öltima Actualizaci√≥n</span></div>
                <div class="stats-item"><span id="dbStatus" class="stats-number">üîÑ</span><span class="stats-label">Estado DB</span></div>
             </div>
             <div class="panel"><h2>üìä Analytics</h2><div id="analyticsContainer"><div class="loading"></div></div></div>
             <div class="admin-controls">
                <div class="panel">
                     <h2 id="formTitle">‚ûï Agregar Script</h2><div id="alertContainer"></div>
                     <form id="scriptForm"><div class="form-group"><label>Categor√≠a</label><select id="scriptCategory"></select></div><div class="form-group"><label>T√≠tulo</label><input type="text" id="scriptTitle" required></div><div class="form-group"><label>Texto</label><textarea id="scriptText" required></textarea></div><button type="submit" class="admin-btn success">Guardar</button><button type="button" class="admin-btn danger" onclick="clearForm()">Limpiar</button></form>
                </div>
                <div class="panel">
                     <h2>üìù Scripts Existentes</h2><div class="form-group"><label>Filtrar</label><select id="filterCategory"></select></div><div class="scripts-list" id="scriptsList"></div>
                </div>
            </div>
            <div class="panel">
                <h2>üíæ Gesti√≥n de Backups</h2>
                <div id="backup-controls">
                    <button class="admin-btn" onclick="downloadBackup()">üì• Crear y Descargar Backup</button>
                    <input type="file" id="restoreFile" class="hidden" onchange="restoreFromBackup(this.files[0])">
                    <button class="admin-btn danger" onclick="document.getElementById('restoreFile').click()">üîß Restaurar desde Archivo</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- GLOBAL VARIABLES & CONFIG ---
        const API_BASE_URL = '';
        let SCRIPTS_DATA = {};
        let currentEditingId = null;
        let isAuthenticated = false;
        let debounceTimer;

        // --- CORE & API FUNCTIONS ---
        function showAlert(message, type = 'success') {
            const container = document.getElementById('alertContainer');
            if (!container) return;
            const alertEl = document.createElement('div');
            alertEl.className = `alert ${type}`;
            alertEl.textContent = message;
            container.prepend(alertEl);
            setTimeout(() => alertEl.remove(), 4000);
        }

        async function apiCall(endpoint, options = {}) {
            try {
                const response = await fetch(`${API_BASE_URL}${endpoint}`, options);
                updateConnectionStatus(true);
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({error: 'Error de servidor'}));
                    throw new Error(errorData.error || `Error HTTP: ${response.status}`);
                }
                return response.headers.get("content-type")?.includes("application/json") ? response.json() : response.blob();
            } catch (error) {
                updateConnectionStatus(false);
                showAlert(`Error de Red: ${error.message}`, 'error');
                throw error;
            }
        }
        
        async function fetchAllData() {
            const container = document.getElementById('scriptsContainer');
            if (container) container.innerHTML = '<div class="loading"></div>';
            try {
                const data = await apiCall('/api/scripts');
                SCRIPTS_DATA = data;
                renderVentasUI();
                updateSystemStatus();
            } catch (error) {
                if(container) container.innerHTML = `<div class="error-message">Fallo al cargar scripts.</div>`;
            }
        }

        // --- UI & MODE MANAGEMENT ---
        function switchMode(mode, fromAuth = false) {
            const ventasMode = document.getElementById('ventasMode');
            const adminMode = document.getElementById('adminMode');
            const modeButtons = document.querySelectorAll('.mode-btn');

            if (mode === 'admin' && !fromAuth) { showAuthModal(); return; }
            
            modeButtons.forEach(btn => btn.classList.remove('active'));
            if (mode === 'ventas') {
                ventasMode.style.display = 'block';
                adminMode.style.display = 'none';
                modeButtons[0].classList.add('active');
            } else {
                ventasMode.style.display = 'none';
                adminMode.style.display = 'block';
                modeButtons[1].classList.add('active');
                loadAdminData();
            }
        }

        function renderVentasUI() {
            const tabsContainer = document.getElementById('categoryTabs');
            const scriptsContainer = document.getElementById('scriptsContainer');
            if (!tabsContainer || !scriptsContainer) return;
            tabsContainer.innerHTML = '';
            scriptsContainer.innerHTML = '';
            const categoryNames = {bienvenida: "üí¨ Bienvenida", calificacion: "üîç Calificaci√≥n", objeciones: "üõ°Ô∏è Objeciones", seguimiento: "üìû Seguimiento", cierre: "üéØ Cierre"};
            Object.keys(categoryNames).forEach((category, index) => {
                const tab = document.createElement('button');
                tab.className = `tab ${index === 0 ? 'active' : ''}`;
                tab.textContent = categoryNames[category];
                tab.onclick = (e) => showTab(category, e.target);
                tabsContainer.appendChild(tab);
                const section = document.createElement('div');
                section.id = category;
                section.className = `tab-section ${index > 0 ? 'hidden' : ''}`;
                if(SCRIPTS_DATA[category] && SCRIPTS_DATA[category].length > 0) {
                    section.innerHTML = SCRIPTS_DATA[category].map(createScriptCardHTML).join('');
                } else {
                    section.innerHTML = `<div class="empty-state">No hay scripts en esta categor√≠a.</div>`;
                }
                scriptsContainer.appendChild(section);
            });
        }
        
        function createScriptCardHTML(script) {
            const badgeHTML = script.badge ? `<span class="script-badge" style="background-color: ${script.badge.color || '#6c757d'}">${script.badge.icon} ${script.badge.text}</span>` : '';
            return `
                <div class="script-card" data-script-id="${script.id}">
                    <div class="script-title">${script.title}${badgeHTML}</div>
                    <div class="script-text">${script.text}</div>
                    <div class="usage-stats"><span>üìä ${script.usage_30_days || 0} usos (30d)</span><span>üìà ${script.usage_7_days || 0} usos (7d)</span></div>
                    <button class="copy-btn" onclick="copyAndTrack(${script.id})">üìã Copiar</button>
                </div>`;
        }
        
        function showTab(category, clickedTab) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-section').forEach(s => s.classList.add('hidden'));
            clickedTab.classList.add('active');
            document.getElementById(category).classList.remove('hidden');
        }

        function updateSystemStatus() {
            const totalCount = SCRIPTS_DATA ? Object.values(SCRIPTS_DATA).reduce((sum, cat) => sum + (Array.isArray(cat) ? cat.length : 0), 0) : 0;
            const statusEl = document.getElementById('systemStatus');
            if (statusEl) {
                statusEl.innerHTML = `‚úÖ Sistema activo - ${totalCount} scripts disponibles - Actualizado: ${new Date().toLocaleTimeString()}`;
            }
        }

        function updateConnectionStatus(isOnline) {
            const el = document.getElementById('connectionStatus');
            const headerStatus = document.getElementById('systemStatus');
            if (el) {
                el.textContent = isOnline ? 'üü¢ En l√≠nea' : 'üî¥ Sin conexi√≥n';
                el.className = `connection-status ${isOnline ? 'online' : 'offline'}`;
            }
            if (headerStatus) {
                headerStatus.className = `status ${isOnline ? 'online' : 'offline'}`;
                if (!isOnline) headerStatus.textContent = 'üî¥ Error de Servidor';
            }
        }
        
        async function copyAndTrack(scriptId) {
            const card = document.querySelector(`.script-card[data-script-id="${scriptId}"]`);
            const text = card.querySelector('.script-text').innerText;
            const button = card.querySelector('.copy-btn');
            navigator.clipboard.writeText(text).then(() => {
                button.textContent = '‚úÖ Copiado';
                button.classList.add('copied');
                setTimeout(() => { button.textContent = 'üìã Copiar'; button.classList.remove('copied'); }, 2000);
            });
            try { await apiCall(`/api/scripts/${scriptId}/track`, { method: 'POST' }); } catch(e) {}
        }

        // --- ADMIN FUNCTIONS ---
        function loadAdminData() {
            populateCategorySelect('scriptCategory');
            populateCategorySelect('filterCategory');
            renderAdminList();
            loadAnalyticsDashboard();
            updateAdminStats();
        }
        
        function populateCategorySelect(selectId) {
             const select = document.getElementById(selectId);
             if(!select) return;
             select.innerHTML = ''; 
             if (selectId === 'filterCategory') select.innerHTML = `<option value="all">Todas</option>`;
             const categoryNames = {bienvenida: "üí¨ Bienvenida", calificacion: "üîç Calificaci√≥n", objeciones: "üõ°Ô∏è Objeciones", seguimiento: "üìû Seguimiento", cierre: "üéØ Cierre"};
             Object.keys(categoryNames).forEach(key => select.innerHTML += `<option value="${key}">${categoryNames[key]}</option>`);
        }
        
        function renderAdminList() {
             const listContainer = document.getElementById('scriptsList');
             const filter = document.getElementById('filterCategory').value;
             if (!listContainer) return;
             listContainer.innerHTML = '';
             let hasScripts = false;
             Object.keys(SCRIPTS_DATA).forEach(category => {
                 if (filter === 'all' || filter === category) {
                     if (SCRIPTS_DATA[category] && SCRIPTS_DATA[category].length > 0) {
                         hasScripts = true;
                         SCRIPTS_DATA[category].forEach(script => {
                             listContainer.innerHTML += `<div class="script-item"><h4>${script.title}</h4><div class="script-item-actions"><button class="edit-btn" onclick="editScript(${script.id})">‚úèÔ∏è Editar</button><button class="delete-btn" onclick="deleteScript(${script.id})">üóëÔ∏è Eliminar</button></div></div>`;
                         });
                     }
                 }
             });
             if (!hasScripts) listContainer.innerHTML = `<div class="empty-state">No hay scripts.</div>`;
        }
        
        async function handleAdminFormSubmit(e) {
            e.preventDefault();
            const payload = {
                category: document.getElementById('scriptCategory').value,
                title: document.getElementById('scriptTitle').value,
                text: document.getElementById('scriptText').value
            };
            const endpoint = currentEditingId ? `/api/scripts/${currentEditingId}` : '/api/scripts';
            const method = currentEditingId ? 'PUT' : 'POST';
            try {
                await apiCall(endpoint, { method, headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer DPI2025Admin' }, body: JSON.stringify(payload) });
                showAlert(`Script ${currentEditingId ? 'actualizado' : 'creado'}`, 'success');
                clearForm();
                await fetchAllData();
                renderAdminList();
            } catch(e) {}
        }

        function editScript(id) {
            let scriptToEdit, categoryKey;
            for (const category in SCRIPTS_DATA) {
                const found = SCRIPTS_DATA[category].find(s => s.id === id);
                if (found) { scriptToEdit = found; categoryKey = category; break; }
            }
            if (scriptToEdit) {
                currentEditingId = id;
                document.getElementById('formTitle').textContent = `‚úèÔ∏è Editando: ${scriptToEdit.title}`;
                document.getElementById('scriptCategory').value = categoryKey;
                document.getElementById('scriptTitle').value = scriptToEdit.title;
                document.getElementById('scriptText').value = scriptToEdit.text;
                document.querySelector('#formTitle').scrollIntoView({behavior: 'smooth'});
            }
        }
        
        async function deleteScript(id) {
            if (confirm(`¬øEliminar script ID ${id}?`)) {
                try {
                    await apiCall(`/api/scripts/${id}`, { method: 'DELETE', headers: { 'Authorization': 'Bearer DPI2025Admin' } });
                    showAlert('Script eliminado', 'success');
                    await fetchAllData();
                    renderAdminList();
                } catch(e) {}
            }
        }

        function clearForm() {
            currentEditingId = null;
            document.getElementById('scriptForm').reset();
            document.getElementById('formTitle').textContent = '‚ûï Agregar Script';
        }

        async function loadAnalyticsDashboard() {
            const container = document.getElementById('analyticsContainer');
            if(!container) return;
            container.innerHTML = '<div class="loading"></div>';
            try {
                const data = await apiCall('/api/analytics', { headers: { 'Authorization': 'Bearer DPI2025Admin' } });
                let html = '<h4>üèÜ Top Scripts (30 d√≠as)</h4>';
                data.topScripts.forEach(s => { html += `<div>${s.title}: <strong>${s.uses_30_days}</strong> usos</div>`; });
                html += '<h4 style="margin-top: 15px;">üìä Uso por Categor√≠a</h4>';
                data.categoryStats.forEach(c => { html += `<div>${c.category}: <strong>${c.usage_count}</strong> usos</div>`; });
                container.innerHTML = html;
            } catch(e) { container.innerHTML = '<div class="error-message">Error al cargar analytics.</div>'; }
        }

        function updateAdminStats() {
            const total = SCRIPTS_DATA ? Object.values(SCRIPTS_DATA).reduce((s, c) => s + (Array.isArray(c) ? c.length : 0), 0) : 0;
            document.getElementById('totalScripts').textContent = total;
            document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString();
            document.getElementById('dbStatus').textContent = '‚úÖ';
        }

        // --- BACKUP & RESTORE ---
        async function downloadBackup() {
            try {
                const blob = await apiCall('/api/backup', { headers: { 'Authorization': 'Bearer DPI2025Admin' } });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `backup-${Date.now()}.db`;
                a.click();
                window.URL.revokeObjectURL(url);
            } catch (e) {}
        }
        
        async function restoreFromBackup(file) {
            if (!file) return;
            if (confirm("üö® ¬øEST√ÅS SEGURO? Esto reemplazar√° la base de datos actual.")) {
                const formData = new FormData();
                formData.append('backup', file);
                try {
                    const result = await apiCall('/api/restore', { method: 'POST', headers: { 'Authorization': 'Bearer DPI2025Admin' }, body: formData });
                    showAlert(result.message, 'success');
                    setTimeout(() => location.reload(), 2000);
                } catch(e) {}
            }
        }
        
        // --- SEARCH FUNCTIONS ---
        function performSearch(query) {
             const resultsContainer = document.getElementById('searchResults');
             resultsContainer.innerHTML = `<div class="loading" style="padding:10px;"></div>`;
             resultsContainer.classList.add('active');
             apiCall(`/api/scripts/search?q=${encodeURIComponent(query)}`)
                .then(results => {
                    resultsContainer.innerHTML = results.length > 0
                        ? results.map(r => `<div class="search-result-item" onclick="scrollToScript(${r.id})"><div class="search-result-category">${r.category}</div><div class="search-result-title">${r.highlightedTitle}</div><div class="search-result-preview">${r.highlightedText}</div></div>`).join('')
                        : `<div class="search-result-item">No se encontraron resultados.</div>`;
                })
                .catch(() => { resultsContainer.innerHTML = `<div class="search-result-item error-message">Error en la b√∫squeda.</div>`; });
        }
        
        function scrollToScript(id) {
            document.getElementById('searchResults').classList.remove('active');
            const card = document.querySelector(`.script-card[data-script-id="${id}"]`);
            if (card) {
                const category = Object.keys(SCRIPTS_DATA).find(cat => SCRIPTS_DATA[cat].some(s => s.id === id));
                const tabs = Array.from(document.getElementById('categoryTabs').children);
                const tabToClick = tabs.find(t => t.textContent.toLowerCase().includes(category));
                if(tabToClick) showTab(category, tabToClick);
                setTimeout(() => {
                    card.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    card.style.transition = 'background-color 0.5s';
                    card.style.backgroundColor = '#fff3cd';
                    setTimeout(() => card.style.backgroundColor = '', 2000);
                }, 100);
            }
        }

        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', () => {
            const authForm = document.getElementById('authForm');
            if(authForm) authForm.addEventListener('submit', handleAuth);
            
            const searchInput = document.getElementById('searchInput');
            if(searchInput) {
                 searchInput.addEventListener('keyup', (e) => {
                    clearTimeout(debounceTimer);
                    debounceTimer = setTimeout(() => {
                        const query = e.target.value.trim();
                        if (query.length > 1) performSearch(query);
                        else {
                            const searchResults = document.getElementById('searchResults');
                            if(searchResults) searchResults.classList.remove('active');
                        }
                    }, 300);
                });
            }

            document.addEventListener('click', (e) => {
                const searchBox = e.target.closest('.search-box');
                const searchResults = document.getElementById('searchResults');
                if (!searchBox && searchResults) searchResults.classList.remove('active');
            });

            fetchAllData();
            setInterval(() => updateConnectionStatus(navigator.onLine), 10000);
        });
    </script>
</body>
</html>
