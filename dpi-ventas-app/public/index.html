<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DPI Publicidad - Sistema de Ventas Profesional</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #0FA795; --secondary-color: #8BC34A; --danger-color: #dc3545;
            --warning-color: #ffc107; --info-color: #17a2b8; --success-color: #28a745;
            --dark-color: #2c3e50; --light-color: #ffffff; --bg-color: #f4f7f6; --border-color: #e3e8ee;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Inter', sans-serif; background-color: var(--bg-color); min-height: 100vh; padding: 20px; font-size: 15px; color: var(--dark-color); }
        .container { max-width: 1400px; margin: 0 auto; transition: filter 0.3s ease; }
        .header { text-align: center; color: var(--dark-color); margin-bottom: 30px; }
        .header h1 { font-size: 2.5em; font-weight: 700; margin-bottom: 8px; }
        .header p { font-size: 1.1em; color: #7f8c8d; }
        .header .status { background-color: rgba(0,0,0,0.05); padding: 8px 20px; border-radius: 20px; font-size: 0.9em; margin-top: 15px; display: inline-block; transition: all 0.3s ease; border: 1px solid var(--border-color); }
        .header .status.online { background-color: var(--success-color); color: white; border-color: var(--success-color); }
        .header .status.offline { background-color: var(--danger-color); color: white; border-color: var(--danger-color); }
        .mode-switcher { text-align: center; margin-bottom: 30px; background: #e0e5ec; border-radius: 30px; display: inline-flex; padding: 5px; box-shadow: inset 5px 5px 10px #caced4, inset -5px -5px 10px #f8f9fa; }
        .mode-btn { background: transparent; color: #555; border: none; padding: 10px 25px; border-radius: 25px; font-weight: 600; cursor: pointer; transition: all 0.3s ease; }
        .mode-btn.active { background: var(--primary-color); color: white; box-shadow: 0 4px 15px rgba(15, 167, 149, 0.3); }
        .panel { background: var(--light-color); border-radius: 16px; padding: 25px; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08); margin-bottom: 25px; }
        .panel h2 { font-size: 1.4em; font-weight: 600; margin-bottom: 20px; border-bottom: 2px solid var(--border-color); padding-bottom: 15px; }
        .loading, .empty-state { text-align: center; padding: 50px 20px; color: #7f8c8d; }
        .loading::after { content: ''; display: inline-block; width: 25px; height: 25px; border: 4px solid rgba(0,0,0,0.1); border-top-color: var(--primary-color); border-radius: 50%; animation: spin 1s linear infinite; margin-left: 15px; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .error-message { background: #f8d7da; color: #721c24; padding: 15px; border-radius: 8px; text-align: center; }
        
        /* MODO VENTAS */
        .search-input { width: 100%; padding: 15px 20px; border: 2px solid var(--border-color); border-radius: 12px; font-size: 1em; transition: all 0.3s ease; }
        .search-input:focus { outline: none; border-color: var(--primary-color); box-shadow: 0 0 0 4px rgba(15, 167, 149, 0.1); }
        .semaforo { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 25px; }
        .semaforo-item { padding: 25px; border-radius: 12px; border: 2px solid transparent; }
        .semaforo-item h3 { margin-bottom: 10px; font-size: 1.2em; }
        .semaforo-item p { font-size: 0.9em; margin-bottom: 15px; line-height: 1.5; }
        .semaforo-item ul { list-style: none; padding-left: 0; }
        .semaforo-item li { margin-bottom: 8px; font-weight: 500; }
        .verde { background-color: #e9f9f2; border-color: #a3e9d1; color: #0f5132; }
        .amarillo { background-color: #fff8e1; border-color: #ffecb3; color: #6d4c41; }
        .rojo { background-color: #fdecea; border-color: #f5c6cb; color: #8d2a33; }
        .tabs { display: flex; border-bottom: 2px solid var(--border-color); margin-bottom: 20px; }
        .tab { padding: 15px 20px; background: none; border: none; cursor: pointer; font-weight: 600; font-size: 1em; color: #7f8c8d; position: relative; }
        .tab:after { content: ''; position: absolute; bottom: -2px; left: 0; right: 0; height: 3px; background-color: var(--primary-color); transform: scaleX(0); transition: transform 0.3s ease; }
        .tab.active { color: var(--primary-color); }
        .tab.active:after { transform: scaleX(1); }
        .script-card { background: var(--bg-color); border: 1px solid var(--border-color); border-radius: 12px; padding: 20px; margin-bottom: 15px; transition: all 0.3s ease; }
        .script-card:hover { transform: translateY(-3px); box-shadow: 0 8px 25px rgba(0,0,0,0.07); }
        .script-title { font-weight: 600; font-size: 1.1em; color: var(--dark-color); }
        .script-text { line-height: 1.6; margin: 15px 0; white-space: pre-line; }
        .script-badge { padding: 4px 10px; border-radius: 12px; font-size: 0.75em; color: var(--white-color); }
        .usage-stats { display: flex; gap: 15px; font-size: 0.8em; color: #7f8c8d; }
        .copy-btn { background: var(--primary-color); color: var(--white-color); border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.3s ease; }
        .copy-btn:hover { background: #0c806f; }
        .copy-btn.copied { background: var(--success-color); }
        
        /* MODO ADMIN */
        .admin-mode { display: none; }
        .admin-mode.visible { display: block; }
        .stats-bar { display: flex; justify-content: space-around; background: var(--dark-color); color: white; padding: 20px; border-radius: 12px; margin-bottom: 25px; }
        .stats-item { text-align: center; }
        .stats-number { font-size: 2em; font-weight: 700; }
        .stats-label { font-size: 0.9em; opacity: 0.8; }
        .admin-controls { display: grid; grid-template-columns: 1fr 1.2fr; gap: 25px; }
        .admin-btn { padding: 12px 25px; border-radius: 8px; cursor: pointer; font-weight: 600; }
        .edit-btn { background: var(--info-color); }
        .delete-btn { background: var(--danger-color); }
        .scripts-list { max-height: 500px; overflow-y: auto; }
        .script-item { display: flex; justify-content: space-between; align-items: center; padding: 15px; background: var(--bg-color); border-radius: 8px; margin-bottom: 10px; }
        
        /* MODAL DE AUTH */
        .auth-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); backdrop-filter: blur(8px); z-index: 9999; display: none; justify-content: center; align-items: center; }
        .auth-overlay.active { display: flex; }
        .auth-modal { background: var(--light-color); border-radius: 16px; padding: 40px; width: 90%; max-width: 400px; text-align: center; box-shadow: 0 20px 50px rgba(0,0,0,0.2); }
        .auth-modal h2 { font-size: 1.8em; margin-bottom: 10px; }
        .auth-error { background: #f8d7da; color: #721c24; padding: 10px; border-radius: 8px; margin-bottom: 15px; display: none; }
        .auth-input { width: 100%; padding: 15px; margin-bottom: 10px; border: 2px solid var(--border-color); border-radius: 8px; font-size: 1em; }
    </style>
</head>
<body>
    <div id="connectionStatus" class="connection-status offline">üî¥ Conectando...</div>
    <div class="auth-overlay" id="authOverlay">
        <div class="auth-modal">
            <h2>üîê Acceso Administrativo</h2>
            <p>Ingresa tus credenciales para continuar</p>
            <div id="authError" class="auth-error">Usuario o Contrase√±a incorrectos</div>
            <form id="authForm" style="margin-top: 20px;">
                <input type="text" id="authUsername" class="auth-input" placeholder="Usuario" required>
                <input type="password" id="authPassword" class="auth-input" placeholder="Contrase√±a" required>
                <button type="submit" class="admin-btn success">Ingresar</button>
                <button type="button" class="admin-btn danger" onclick="cancelAuth()">Cancelar</button>
            </form>
        </div>
    </div>
    <div class="container" id="mainContent">
        <div class="header">
            <h1>DPI Publicidad - Sistema Railway</h1>
            <p>Rotulos ‚Ä¢ Material POP ‚Ä¢ Stands ‚Ä¢ Banners ‚Ä¢ Viniles</p>
            <div class="status" id="systemStatus">Conectando al servidor...</div>
        </div>
        <div style="text-align:center;">
            <div class="mode-switcher">
                <button class="mode-btn active" onclick="switchMode('ventas')">üì± Modo Ventas</button>
                <button class="mode-btn" onclick="switchMode('admin')">‚öôÔ∏è Modo Admin</button>
            </div>
        </div>
        <div class="ventas-mode" id="ventasMode">
            <div class="panel">
                <h2>üö¶ SEM√ÅFORO DE CALIFICACI√ìN (M√©todo Carnegie)</h2>
                 <div class="semaforo">
                    <div class="semaforo-item verde"><h3>üü¢ LUZ VERDE: COTIZAR</h3><p>El cliente se siente escuchado, conf√≠a en nosotros y entiende el valor.</p><ul><li>‚úì Entendimos su "porqu√©".</li><li>‚úì Validamos su presupuesto.</li><li>‚úì Confirm√≥ que le gusta la idea.</li><li>‚úì El decisor est√° involucrado.</li></ul></div>
                    <div class="semaforo-item amarillo"><h3>üü° LUZ AMARILLA: INVESTIGAR</h3><p>A√∫n no entendemos la necesidad real. Es momento de preguntar, no de proponer.</p><ul><li>! Habla solo de precio.</li><li>! No tiene claro el objetivo.</li><li>! Pide "ideas" sin contexto.</li><li>! No es el decisor final.</li></ul></div>
                    <div class="semaforo-item rojo"><h3>üî¥ LUZ ROJA: PAUSAR</h3><p>Riesgo alto de ser una "cotizaci√≥n fantasma". Invertir tiempo aqu√≠ es costoso.</p><ul><li>‚Ä¢ "Solo para tener una idea".</li><li>‚Ä¢ Sin presupuesto ni urgencia.</li><li>‚Ä¢ No responde preguntas clave.</li><li>‚Ä¢ "Env√≠eme lo que tengas".</li></ul></div>
                </div>
            </div>
            <div class="panel">
                <div class="tabs" id="categoryTabs"><div class="loading"></div></div>
                <div class="tab-content" id="scriptsContainer"><div class="loading"></div></div>
            </div>
        </div>
        <div class="admin-mode" id="adminMode">
             <div class="panel stats-bar" id="statsBar"></div>
             <div class="panel"><h2>üìä Analytics</h2><div id="analyticsContainer"><div class="loading"></div></div></div>
             <div class="admin-controls">
                <div class="panel">
                     <h2 id="formTitle">‚ûï Agregar Script</h2><div id="alertContainer"></div>
                     <form id="scriptForm"><div class="form-group"><label>Categor√≠a</label><select id="scriptCategory"></select></div><div class="form-group"><label>T√≠tulo</label><input type="text" id="scriptTitle" required></div><div class="form-group"><label>Texto</label><textarea id="scriptText" required></textarea></div><button type="submit" class="admin-btn success">Guardar</button><button type="button" class="admin-btn danger" onclick="clearForm()">Limpiar</button></form>
                </div>
                <div class="panel">
                     <h2>üìù Scripts Existentes</h2><div class="form-group"><label>Filtrar</label><select id="filterCategory"></select></div><div class="scripts-list" id="scriptsList"></div>
                </div>
            </div>
            <div class="panel">
                <h2>üíæ Gesti√≥n de Backups</h2>
                <div id="backup-controls">
                    <button class="admin-btn" onclick="downloadBackup()">üì• Descargar Backup Actual</button>
                    <input type="file" id="restoreFile" class="hidden" onchange="restoreFromBackup(this.files[0])">
                    <button class="admin-btn danger" onclick="document.getElementById('restoreFile').click()">üîß Restaurar desde Archivo</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- GLOBAL VARIABLES & CONFIG ---
        const API_BASE_URL = '';
        let SCRIPTS_DATA = {};
        let currentEditingId = null;
        let isAuthenticated = false;
        let debounceTimer;

        // --- FUNCTION DEFINITIONS ---
        function showAlert(message, type = 'success') {
            const container = document.getElementById('alertContainer');
            if (!container) return;
            const alertEl = document.createElement('div');
            alertEl.className = `alert ${type}`;
            alertEl.textContent = message;
            container.prepend(alertEl);
            setTimeout(() => alertEl.remove(), 4000);
        }

        async function apiCall(endpoint, options = {}) {
            try {
                const response = await fetch(`${API_BASE_URL}${endpoint}`, options);
                updateConnectionStatus(true);
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({error: 'Error de servidor'}));
                    throw new Error(errorData.error || `Error HTTP: ${response.status}`);
                }
                return response.headers.get("content-type")?.includes("application/json") ? response.json() : response.blob();
            } catch (error) {
                updateConnectionStatus(false);
                console.error(`API call a ${endpoint} fall√≥:`, error);
                showAlert(`Error de Red: ${error.message}`, 'error');
                throw error;
            }
        }
        
        function updateConnectionStatus(isOnline) {
            const el = document.getElementById('connectionStatus');
            const headerStatus = document.getElementById('systemStatus');
            if (el) {
                el.textContent = isOnline ? 'üü¢ En l√≠nea' : 'üî¥ Sin conexi√≥n';
                el.className = `connection-status ${isOnline ? 'online' : 'offline'}`;
            }
            if (headerStatus) {
                headerStatus.className = `status ${isOnline ? 'online' : 'offline'}`;
                if (!isOnline) headerStatus.textContent = 'üî¥ Error de Servidor';
            }
        }

        async function fetchAllData() {
            const container = document.getElementById('scriptsContainer');
            if (container) container.innerHTML = '<div class="loading"></div>';
            try {
                const data = await apiCall('/api/scripts');
                SCRIPTS_DATA = data;
                renderVentasUI();
                updateSystemStatus();
            } catch (error) {
                if(container) container.innerHTML = `<div class="error-message">Fallo al cargar scripts.</div>`;
            }
        }
        
        function showAuthModal() {
            const overlay = document.getElementById('authOverlay');
            if (overlay) {
                overlay.classList.add('active');
                document.getElementById('mainContent').style.filter = 'blur(5px)';
                setTimeout(() => document.getElementById('authUsername').focus(), 100);
            }
        }
        function hideAuthModal() {
            document.getElementById('authOverlay').classList.remove('active');
            document.getElementById('mainContent').style.filter = 'none';
        }
        function cancelAuth() {
            hideAuthModal();
            const buttons = document.querySelectorAll('.mode-btn');
            buttons[0].classList.add('active');
            buttons[1].classList.remove('active');
        }
        function handleAuth(e) {
            e.preventDefault();
            const username = document.getElementById('authUsername').value;
            const password = document.getElementById('authPassword').value;
            const errorEl = document.getElementById('authError');
            if (username === 'admin' && password === 'DPI2025Admin') {
                isAuthenticated = true;
                hideAuthModal();
                switchMode('admin', true);
            } else {
                if (errorEl) errorEl.style.display = 'block';
            }
        }

        function switchMode(mode, fromAuth = false) {
            const ventasMode = document.getElementById('ventasMode');
            const adminMode = document.getElementById('adminMode');
            const modeButtons = document.querySelectorAll('.mode-btn');

            if (mode === 'admin' && !fromAuth) { showAuthModal(); return; }
            
            modeButtons.forEach(btn => btn.classList.remove('active'));
            if (mode === 'ventas') {
                ventasMode.style.display = 'block';
                adminMode.style.display = 'none';
                modeButtons[0].classList.add('active');
                fetchAllData();
            } else {
                ventasMode.style.display = 'none';
                adminMode.style.display = 'block';
                modeButtons[1].classList.add('active');
                loadAdminData();
            }
        }

        function renderVentasUI() {
            const tabsContainer = document.getElementById('categoryTabs');
            const scriptsContainer = document.getElementById('scriptsContainer');
            if (!tabsContainer || !scriptsContainer) return;
            tabsContainer.innerHTML = '';
            scriptsContainer.innerHTML = '';
            const categoryNames = {bienvenida: "üí¨ Bienvenida", calificacion: "üîç Calificaci√≥n", objeciones: "üõ°Ô∏è Objeciones", seguimiento: "üìû Seguimiento", cierre: "üéØ Cierre"};
            Object.keys(categoryNames).forEach((category, index) => {
                const tab = document.createElement('button');
                tab.className = `tab ${index === 0 ? 'active' : ''}`;
                tab.textContent = categoryNames[category];
                tab.onclick = (e) => showTab(category, e.target);
                tabsContainer.appendChild(tab);
                const section = document.createElement('div');
                section.id = category;
                section.className = `tab-section ${index > 0 ? 'hidden' : ''}`;
                if(SCRIPTS_DATA[category] && SCRIPTS_DATA[category].length > 0) {
                    section.innerHTML = SCRIPTS_DATA[category].map(createScriptCardHTML).join('');
                } else {
                    section.innerHTML = `<div class="empty-state">No hay scripts en esta categor√≠a.</div>`;
                }
                scriptsContainer.appendChild(section);
            });
        }
        
        function createScriptCardHTML(script) {
            const badgeHTML = script.badge ? `<span class="script-badge" style="background-color: ${script.badge.color || '#6c757d'}">${script.badge.icon} ${script.badge.text}</span>` : '';
            return `
                <div class="script-card" data-script-id="${script.id}">
                    <div class="script-title">${script.title}${badgeHTML}</div>
                    <div class="script-text">${script.text}</div>
                    <div class="usage-stats"><span>üìä ${script.usage_30_days || 0} usos (30d)</span><span>üìà ${script.usage_7_days || 0} usos (7d)</span></div>
                    <button class="copy-btn" onclick="copyAndTrack(${script.id})">üìã Copiar</button>
                </div>`;
        }
        
        function showTab(category, clickedTab) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-section').forEach(s => s.classList.add('hidden'));
            clickedTab.classList.add('active');
            document.getElementById(category).classList.remove('hidden');
        }

        function updateSystemStatus() {
            const totalCount = SCRIPTS_DATA ? Object.values(SCRIPTS_DATA).reduce((sum, cat) => sum + (Array.isArray(cat) ? cat.length : 0), 0) : 0;
            const statusEl = document.getElementById('systemStatus');
            if (statusEl) {
                statusEl.innerHTML = `‚úÖ Sistema activo - ${totalCount} scripts disponibles - Actualizado: ${new Date().toLocaleTimeString()}`;
            }
        }
        
        async function copyAndTrack(scriptId) {
            const card = document.querySelector(`.script-card[data-script-id="${scriptId}"]`);
            const text = card.querySelector('.script-text').innerText;
            const button = card.querySelector('.copy-btn');
            navigator.clipboard.writeText(text).then(() => {
                button.textContent = '‚úÖ Copiado';
                button.classList.add('copied');
                setTimeout(() => { button.textContent = 'üìã Copiar'; button.classList.remove('copied'); }, 2000);
            });
            try { await apiCall(`/api/scripts/${scriptId}/track`, { method: 'POST' }); } catch(e) {}
        }

        function loadAdminData() {
            populateCategorySelect('scriptCategory');
            populateCategorySelect('filterCategory');
            renderAdminList();
            loadAnalyticsDashboard();
            updateAdminStats();
        }

        function populateCategorySelect(selectId) {
             const select = document.getElementById(selectId);
             if(!select) return;
             select.innerHTML = ''; 
             if (selectId === 'filterCategory') select.innerHTML = `<option value="all">Todas</option>`;
             const categoryNames = {bienvenida: "üí¨ Bienvenida", calificacion: "üîç Calificaci√≥n", objeciones: "üõ°Ô∏è Objeciones", seguimiento: "üìû Seguimiento", cierre: "üéØ Cierre"};
             Object.keys(categoryNames).forEach(key => select.innerHTML += `<option value="${key}">${categoryNames[key]}</option>`);
        }
        
        function renderAdminList() {
             const listContainer = document.getElementById('scriptsList');
             const filter = document.getElementById('filterCategory').value;
             if (!listContainer) return;
             listContainer.innerHTML = '';
             let hasScripts = false;
             Object.keys(SCRIPTS_DATA).forEach(category => {
                 if (filter === 'all' || filter === category) {
                     if (SCRIPTS_DATA[category] && SCRIPTS_DATA[category].length > 0) {
                         hasScripts = true;
                         SCRIPTS_DATA[category].forEach(script => {
                             listContainer.innerHTML += `<div class="script-item"><h4>${script.title}</h4><div class="script-item-actions"><button class="edit-btn" onclick="editScript(${script.id})">‚úèÔ∏è Editar</button><button class="delete-btn" onclick="deleteScript(${script.id})">üóëÔ∏è Eliminar</button></div></div>`;
                         });
                     }
                 }
             });
             if (!hasScripts) listContainer.innerHTML = `<div class="empty-state">No hay scripts.</div>`;
        }
        
        async function handleAdminFormSubmit(e) {
            e.preventDefault();
            const payload = {
                category: document.getElementById('scriptCategory').value,
                title: document.getElementById('scriptTitle').value,
                text: document.getElementById('scriptText').value
            };
            const endpoint = currentEditingId ? `/api/scripts/${currentEditingId}` : '/api/scripts';
            const method = currentEditingId ? 'PUT' : 'POST';
            try {
                await apiCall(endpoint, { method, headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer DPI2025Admin' }, body: JSON.stringify(payload) });
                showAlert(`Script ${currentEditingId ? 'actualizado' : 'creado'}`, 'success');
                clearForm();
                await fetchAllData();
                renderAdminList();
            } catch(e) {}
        }

        function editScript(id) {
            let scriptToEdit, categoryKey;
            for (const category in SCRIPTS_DATA) {
                const found = SCRIPTS_DATA[category].find(s => s.id === id);
                if (found) { scriptToEdit = found; categoryKey = category; break; }
            }
            if (scriptToEdit) {
                currentEditingId = id;
                document.getElementById('formTitle').textContent = `‚úèÔ∏è Editando: ${scriptToEdit.title}`;
                document.getElementById('scriptCategory').value = categoryKey;
                document.getElementById('scriptTitle').value = scriptToEdit.title;
                document.getElementById('scriptText').value = scriptToEdit.text;
                document.querySelector('#formTitle').scrollIntoView({behavior: 'smooth'});
            }
        }
        
        async function deleteScript(id) {
            if (confirm(`¬øEliminar script ID ${id}?`)) {
                try {
                    await apiCall(`/api/scripts/${id}`, { method: 'DELETE', headers: { 'Authorization': 'Bearer DPI2025Admin' } });
                    showAlert('Script eliminado', 'success');
                    await fetchAllData();
                    renderAdminList();
                } catch(e) {}
            }
        }

        function clearForm() {
            currentEditingId = null;
            document.getElementById('scriptForm').reset();
            document.getElementById('formTitle').textContent = '‚ûï Agregar Script';
        }

        async function loadAnalyticsDashboard() {
            const container = document.getElementById('analyticsContainer');
            if(!container) return;
            container.innerHTML = '<div class="loading"></div>';
            try {
                const data = await apiCall('/api/analytics', { headers: { 'Authorization': 'Bearer DPI2025Admin' } });
                let html = '<h4>üèÜ Top Scripts (30 d√≠as)</h4>';
                data.topScripts.forEach(s => { html += `<div>${s.title}: <strong>${s.uses_30_days}</strong> usos</div>`; });
                html += '<h4 style="margin-top: 15px;">üìä Uso por Categor√≠a</h4>';
                data.categoryStats.forEach(c => { html += `<div>${c.category}: <strong>${c.usage_count}</strong> usos</div>`; });
                container.innerHTML = html;
            } catch(e) { container.innerHTML = '<div class="error-message">Error al cargar analytics.</div>'; }
        }

        function updateAdminStats() {
            const total = SCRIPTS_DATA ? Object.values(SCRIPTS_DATA).reduce((s, c) => s + (Array.isArray(c) ? c.length : 0), 0) : 0;
            document.getElementById('totalScripts').textContent = total;
            document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString();
            document.getElementById('dbStatus').textContent = '‚úÖ';
        }
        
        async function loadScriptsListAdmin() {
            const listContainer = document.getElementById('scriptsList');
            if (!listContainer) return;
            listContainer.innerHTML = '<div class="loading"></div>';
            populateCategorySelect('scriptCategory');
            populateCategorySelect('filterCategory');
            await fetchAllData();
            renderAdminList();
        }

        async function downloadBackup() {
            try {
                const blob = await apiCall('/api/backup', { headers: { 'Authorization': 'Bearer DPI2025Admin' } });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `backup-${Date.now()}.db`;
                a.click();
                window.URL.revokeObjectURL(url);
            } catch (e) {}
        }
        
        async function restoreFromBackup(file) {
            if (!file) return;
            if (confirm("üö® ¬øEST√ÅS SEGURO? Esto reemplazar√° la base de datos actual.")) {
                const formData = new FormData();
                formData.append('backup', file);
                try {
                    const result = await apiCall('/api/restore', { method: 'POST', headers: { 'Authorization': 'Bearer DPI2025Admin' }, body: formData });
                    showAlert(result.message, 'success');
                    setTimeout(() => location.reload(), 2000);
                } catch(e) {}
            }
        }
        
        function performSearch(query) {
             const resultsContainer = document.getElementById('searchResults');
             resultsContainer.innerHTML = `<div class="loading" style="padding:10px;"></div>`;
             resultsContainer.classList.add('active');
             apiCall(`/api/scripts/search?q=${encodeURIComponent(query)}`)
                .then(results => {
                    resultsContainer.innerHTML = results.length > 0
                        ? results.map(r => `<div class="search-result-item" onclick="scrollToScript(${r.id})"><div class="search-result-category">${r.category}</div><div class="search-result-title">${r.highlightedTitle}</div><div class="search-result-preview">${r.highlightedText}</div></div>`).join('')
                        : `<div class="search-result-item">No se encontraron resultados.</div>`;
                })
                .catch(() => { resultsContainer.innerHTML = `<div class="search-result-item error-message">Error en la b√∫squeda.</div>`; });
        }
        
        function scrollToScript(id) {
            document.getElementById('searchResults').classList.remove('active');
            const card = document.querySelector(`.script-card[data-script-id="${id}"]`);
            if (card) {
                const category = Object.keys(SCRIPTS_DATA).find(cat => SCRIPTS_DATA[cat].some(s => s.id === id));
                const tabs = Array.from(document.getElementById('categoryTabs').children);
                const tabToClick = tabs.find(t => t.textContent.toLowerCase().includes(category));
                if(tabToClick) showTab(category, tabToClick);
                setTimeout(() => {
                    card.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    card.style.transition = 'background-color 0.5s';
                    card.style.backgroundColor = '#fff3cd';
                    setTimeout(() => card.style.backgroundColor = '', 2000);
                }, 100);
            }
        }

        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('authForm').addEventListener('submit', handleAuth);
            document.getElementById('searchInput').addEventListener('keyup', (e) => {
                clearTimeout(debounceTimer);
                debounceTimer = setTimeout(() => {
                    const query = e.target.value.trim();
                    if (query.length > 1) performSearch(query);
                    else document.getElementById('searchResults').classList.remove('active');
                }, 300);
            });
            document.addEventListener('click', (e) => {
                const searchBox = e.target.closest('.search-box');
                if (!searchBox) document.getElementById('searchResults').classList.remove('active');
            });
            fetchAllData();
            setInterval(() => updateConnectionStatus(navigator.onLine), 10000);
        });
    </script>
</body>
</html>
