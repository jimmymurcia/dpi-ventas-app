<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DPI Publicidad - Sistema de Ventas Profesional</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #0FA795; 
            --secondary-color: #8BC34A; 
            --danger-color: #dc3545;
            --warning-color: #ffc107; 
            --info-color: #17a2b8; 
            --success-color: #28a745;
            --dark-color: #2c3e50; 
            --light-color: #ffffff; 
            --white-color: #ffffff;
            --bg-color: #f4f7f6; 
            --border-color: #e3e8ee;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: var(--bg-color); 
            min-height: 100vh; 
            padding: 20px; 
            font-size: 15px; 
            color: var(--dark-color); 
        }
        .container { 
            max-width: 1400px; 
            margin: 0 auto; 
            transition: filter 0.3s ease; 
        }
        .header { 
            text-align: center; 
            color: var(--dark-color); 
            margin-bottom: 30px; 
        }
        .header h1 { 
            font-size: 2.5em; 
            font-weight: 700; 
            margin-bottom: 8px; 
        }
        .header p { 
            font-size: 1.1em; 
            color: #7f8c8d; 
        }
        .header .status { 
            background-color: rgba(0,0,0,0.05); 
            padding: 8px 20px; 
            border-radius: 20px; 
            font-size: 0.9em; 
            margin-top: 15px; 
            display: inline-block; 
            transition: all 0.3s ease; 
            border: 1px solid var(--border-color); 
        }
        .header .status.online { 
            background-color: var(--success-color); 
            color: white; 
            border-color: var(--success-color); 
        }
        .header .status.offline { 
            background-color: var(--danger-color); 
            color: white; 
            border-color: var(--danger-color); 
        }
        .mode-switcher-wrapper { 
            text-align: center; 
            margin-bottom: 30px; 
        }
        .mode-switcher { 
            background: #e0e5ec; 
            border-radius: 30px; 
            display: inline-flex; 
            padding: 5px; 
            box-shadow: inset 5px 5px 10px #caced4, inset -5px -5px 10px #f8f9fa; 
        }
        .mode-btn { 
            background: transparent; 
            color: #555; 
            border: none; 
            padding: 10px 25px; 
            border-radius: 25px; 
            font-weight: 600; 
            cursor: pointer; 
            transition: all 0.3s ease; 
        }
        .mode-btn.active { 
            background: var(--primary-color); 
            color: white; 
            box-shadow: 0 4px 15px rgba(15, 167, 149, 0.3); 
        }
        .panel { 
            background: var(--light-color); 
            border-radius: 16px; 
            padding: 25px; 
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08); 
            margin-bottom: 25px; 
        }
        .panel h2 { 
            font-size: 1.4em; 
            font-weight: 600; 
            margin-bottom: 20px; 
            border-bottom: 2px solid var(--border-color); 
            padding-bottom: 15px; 
        }
        .loading,         .empty-state { 
            text-align: center; 
            padding: 50px 20px; 
            color: #7f8c8d; 
        }
        
        /* üö¶ SEM√ÅFORO DE CALIFICACI√ìN */
        .semaforo-container {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr; /* 3 columnas en una fila */
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .semaforo-light {
            border-radius: 16px;
            padding: 25px;
            color: white;
            font-weight: 600;
            position: relative;
            min-height: 200px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            cursor: pointer;
        }
        
        .semaforo-light:hover {
            transform: translateY(-5px);
        }
        
        .semaforo-light:hover .semaforo-icon {
            transform: scale(1.1);
            background: rgba(255, 255, 255, 0.4);
        }
        
        .semaforo-light::after {
            content: 'Click para ver scripts relacionados';
            position: absolute;
            bottom: 10px;
            right: 15px;
            font-size: 0.7em;
            opacity: 0;
            transition: opacity 0.3s ease;
            background: rgba(0, 0, 0, 0.2);
            padding: 4px 8px;
            border-radius: 8px;
        }
        
        .semaforo-light:hover::after {
            opacity: 1;
        }
        
        .semaforo-light.verde {
            background: linear-gradient(135deg, #4CAF50, #66BB6A);
            box-shadow: 0 8px 25px rgba(76, 175, 80, 0.3);
        }
        
        .semaforo-light.amarillo {
            background: linear-gradient(135deg, #FF9800, #FFB74D);
            box-shadow: 0 8px 25px rgba(255, 152, 0, 0.3);
        }
        
        .semaforo-light.rojo {
            background: linear-gradient(135deg, #F44336, #EF5350);
            box-shadow: 0 8px 25px rgba(244, 67, 54, 0.3);
            /* Removido grid-column: 1 / -1; para mantener en fila */
        }
        
        .semaforo-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5em;
            margin-bottom: 15px;
            align-self: flex-start;
            transition: transform 0.3s ease, background 0.3s ease;
        }
        
        .semaforo-title {
            font-size: 1.3em;
            font-weight: 700;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .semaforo-description {
            font-style: italic;
            margin-bottom: 20px;
            opacity: 0.95;
            line-height: 1.4;
        }
        
        .semaforo-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        
        .semaforo-list li {
            padding: 5px 0;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.95em;
        }
        
        .semaforo-list li::before {
            content: '‚úì';
            font-weight: bold;
            font-size: 1.1em;
        }
        
        .semaforo-light.amarillo .semaforo-list li::before {
            content: '!';
        }
        
        .semaforo-light.rojo .semaforo-list li::before {
            content: '‚Ä¢';
        }
        .loading::after { 
            content: ''; 
            display: inline-block; 
            width: 25px; 
            height: 25px; 
            border: 4px solid rgba(0,0,0,0.1); 
            border-top-color: var(--primary-color); 
            border-radius: 50%; 
            animation: spin 1s linear infinite; 
            margin-left: 15px; 
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        .error-message { 
            background: #f8d7da; 
            color: #721c24; 
            padding: 15px; 
            border-radius: 8px; 
            text-align: center; 
        }
        .search-box { 
            position: relative; 
            padding-bottom: 20px; 
        }
        .search-input { 
            width: 100%; 
            padding: 15px 20px 15px 50px; 
            border: 2px solid var(--border-color); 
            border-radius: 12px; 
            font-size: 1em; 
        }
        .search-input:focus { 
            outline: none; 
            border-color: var(--primary-color); 
        }
        .search-box::before { 
            content: 'üîç'; 
            position: absolute; 
            left: 20px; 
            top: 15px; 
            color: #aaa; 
            font-size: 1.2em; 
            pointer-events: none; 
        }
        .search-results { 
            position: absolute; 
            top: 90%; 
            left: 0; 
            right: 0; 
            background: var(--light-color); 
            border: 1px solid var(--border-color); 
            border-radius: 8px; 
            box-shadow: 0 4px 20px rgba(0,0,0,0.1); 
            max-height: 400px; 
            overflow-y: auto; 
            z-index: 200; 
            display: none; 
        }
        .search-results.active { 
            display: block; 
        }
        .search-result-item { 
            padding: 12px 15px; 
            border-bottom: 1px solid #f1f3f4; 
            cursor: pointer; 
        }
        .search-result-item:hover {
            background-color: var(--bg-color);
        }
        .search-result-category {
            font-size: 0.8em;
            color: var(--primary-color);
            font-weight: 600;
            text-transform: uppercase;
        }
        mark { 
            background: #fff3cd; 
        }
        .tabs { 
            display: flex; 
            border-bottom: 2px solid var(--border-color); 
            margin-bottom: 20px;
            overflow-x: auto; /* Scroll horizontal en m√≥vil */
            -webkit-overflow-scrolling: touch;
        }
        .tab { 
            padding: 15px 20px; 
            background: none; 
            border: none; 
            cursor: pointer; 
            font-weight: 600; 
            font-size: 1em; 
            color: #7f8c8d; 
            position: relative;
            white-space: nowrap; /* Evita que el texto se rompa */
            flex-shrink: 0; /* Evita que se compriman demasiado */
            min-width: max-content; /* Asegura ancho m√≠nimo */
        }
        .tab:after { 
            content: ''; 
            position: absolute; 
            bottom: -2px; 
            left: 0; 
            right: 0; 
            height: 3px; 
            background-color: var(--primary-color); 
            transform: scaleX(0); 
            transition: transform 0.3s ease; 
        }
        .tab.active { 
            color: var(--primary-color); 
        }
        .tab.active:after { 
            transform: scaleX(1); 
        }
        .script-card { 
            background: var(--bg-color); 
            border: 1px solid var(--border-color); 
            border-radius: 12px; 
            padding: 20px; 
            margin-bottom: 15px;
            transition: background-color 0.5s ease;
        }
        .script-title { 
            font-weight: 600; 
            font-size: 1.1em; 
            color: var(--dark-color); 
            display: flex; 
            align-items: center; 
            gap: 10px;
        }
        .script-text { 
            line-height: 1.6; 
            margin: 15px 0; 
            white-space: pre-line; 
        }
        .script-badge { 
            padding: 4px 10px; 
            border-radius: 12px; 
            font-size: 0.75em; 
            color: var(--white-color); 
        }
        .usage-stats { 
            display: flex; 
            gap: 15px; 
            font-size: 0.8em; 
            color: #7f8c8d; 
        }
        .script-actions { 
            margin-top: 15px; 
        }
        .copy-btn { 
            background: var(--primary-color); 
            color: var(--white-color); 
            border: none; 
            padding: 10px 20px; 
            border-radius: 8px; 
            cursor: pointer; 
            font-weight: 600; 
            transition: background-color 0.3s ease;
        }
        .copy-btn.copied { 
            background: var(--success-color); 
        }
        .admin-mode { 
            display: none; 
        }
        .stats-bar { 
            display: flex; 
            justify-content: space-around; 
            background: var(--dark-color); 
            color: white; 
            padding: 20px; 
            border-radius: 12px; 
            margin-bottom: 25px; 
        }
        .stats-item { 
            text-align: center; 
        }
        .stats-number { 
            font-size: 2em; 
            font-weight: 700; 
        }
        .stats-label { 
            font-size: 0.9em; 
            opacity: 0.8; 
        }
        .admin-controls { 
            display: grid; 
            grid-template-columns: 1fr 1.2fr; 
            gap: 25px; 
        }
        .form-group label { 
            display: block; 
            font-weight: 600; 
            margin-bottom: 8px; 
        }
        .form-group select, .form-group input, .form-group textarea { 
            width: 100%; 
            padding: 12px; 
            border: 2px solid var(--border-color); 
            border-radius: 8px; 
            font-size: 1em; 
            font-family: 'Inter', sans-serif;
        }
        .form-group textarea { 
            height: 150px; 
            resize: vertical; 
        }
        .admin-btn { 
            padding: 12px 25px; 
            border-radius: 8px; 
            cursor: pointer; 
            font-weight: 600; 
            border: none; 
            transition: all 0.2s ease; 
            margin-right: 10px;
        }
        .admin-btn.success { 
            background-color: var(--success-color); 
            color: white; 
        }
        .admin-btn.danger { 
            background-color: var(--danger-color); 
            color: white; 
        }
        .scripts-list { 
            max-height: 500px; 
            overflow-y: auto; 
        }
        .script-item { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            padding: 15px; 
            background: var(--bg-color); 
            border-radius: 8px; 
            margin-bottom: 10px; 
        }
        .script-item h4 {
            margin: 0;
            flex: 1;
        }
        .script-item-actions button { 
            color: white; 
            font-size: 0.9em; 
            padding: 8px 15px; 
            border: none; 
            border-radius: 6px; 
            cursor: pointer; 
            margin-left: 5px; 
        }
        .edit-btn { 
            background: var(--info-color); 
        }
        .delete-btn { 
            background: var(--danger-color); 
        }
        .auth-overlay { 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            background: rgba(0,0,0,0.5); 
            backdrop-filter: blur(8px); 
            z-index: 9999; 
            display: none; 
            justify-content: center; 
            align-items: center; 
        }
        .auth-overlay.active { 
            display: flex; 
        }
        .auth-modal { 
            background: var(--light-color); 
            border-radius: 16px; 
            padding: 40px; 
            width: 90%; 
            max-width: 400px; 
            text-align: center; 
            box-shadow: 0 20px 50px rgba(0,0,0,0.2); 
        }
        .auth-error { 
            background: #f8d7da; 
            color: #721c24; 
            padding: 10px; 
            border-radius: 8px; 
            margin-bottom: 15px; 
            display: none; 
        }
        .auth-input { 
            width: 100%; 
            padding: 15px; 
            margin-bottom: 10px; 
            border: 2px solid var(--border-color); 
            border-radius: 8px; 
            font-size: 1em; 
        }
        .connection-status { 
            position: fixed; 
            bottom: 10px; 
            right: 10px; 
            padding: 8px 15px; 
            border-radius: 20px; 
            z-index: 1000; 
            font-weight: 600; 
        }
        .connection-status.online { 
            background: #d4edda; 
            color: #155724; 
        }
        .connection-status.offline { 
            background: #f8d7da; 
            color: #721c24; 
        }
        .hidden { 
            display: none; 
        }
        .alert { 
            padding: 12px; 
            border-radius: 6px; 
            margin-bottom: 15px; 
            font-weight: bold; 
        }
        .alert.success { 
            background: #d4edda; 
            color: #155724; 
        }
        .alert.error { 
            background: #f8d7da; 
            color: #721c24; 
        }
        @media (max-width: 992px) { 
            .admin-controls { 
                grid-template-columns: 1fr; 
            }
            .semaforo-container {
                grid-template-columns: 1fr; /* Una columna en tablets */
                gap: 15px;
            }
        }
        @media (max-width: 768px) { 
            .stats-bar { 
                flex-direction: column; 
                gap: 15px; 
            }
            .semaforo-container {
                grid-template-columns: 1fr; /* Una columna en m√≥vil */
                gap: 15px;
            }
            .semaforo-light {
                min-height: 160px;
                padding: 20px;
            }
            .semaforo-light::after {
                display: none; /* Ocultar tooltip en m√≥viles */
            }
            .tabs {
                border-bottom: 1px solid var(--border-color);
                margin-bottom: 15px;
                gap: 5px; /* Espacio entre tabs en m√≥vil */
            }
            .tab {
                padding: 12px 16px;
                font-size: 0.9em;
                min-width: auto;
            }
            .panel {
                padding: 20px;
                margin-bottom: 20px;
            }
            .panel h2 {
                font-size: 1.2em;
                margin-bottom: 15px;
                padding-bottom: 10px;
            }
        }
        
        /* Estilos adicionales para m√≥viles muy peque√±os */
        @media (max-width: 480px) {
            .header h1 {
                font-size: 2em;
            }
            .header p {
                font-size: 1em;
            }
            .tab {
                padding: 10px 14px;
                font-size: 0.85em;
            }
            .semaforo-light {
                min-height: 140px;
                padding: 15px;
            }
            .semaforo-title {
                font-size: 1.1em;
            }
            .semaforo-description {
                font-size: 0.9em;
            }
            .semaforo-list li {
                font-size: 0.85em;
            }
        }
    </style>
</head>
<body>
    <div id="connectionStatus" class="connection-status offline">üî¥ Conectando...</div>
    
    <div class="auth-overlay" id="authOverlay">
        <div class="auth-modal">
            <h2>üîê Acceso Administrativo</h2>
            <p>Ingresa tus credenciales para continuar</p>
            <div id="authError" class="auth-error">Usuario o Contrase√±a incorrectos</div>
            <form id="authForm" style="margin-top: 20px;">
                <input type="text" id="authUsername" class="auth-input" placeholder="Usuario" required>
                <input type="password" id="authPassword" class="auth-input" placeholder="Contrase√±a" required>
                <button type="submit" class="admin-btn success">Ingresar</button>
                <button type="button" class="admin-btn danger" onclick="cancelAuth()">Cancelar</button>
            </form>
        </div>
    </div>

    <div class="container" id="mainContent">
        <div class="header">
            <h1>DPI Publicidad - Sistema Railway</h1>
            <p>R√≥tulos ‚Ä¢ Material POP ‚Ä¢ Stands ‚Ä¢ Banners ‚Ä¢ Viniles</p>
            <div class="status" id="systemStatus">Conectando al servidor...</div>
        </div>

        <div class="mode-switcher-wrapper">
            <div class="mode-switcher">
                <button class="mode-btn active" onclick="switchMode('ventas')">üì± Modo Ventas</button>
                <button class="mode-btn" onclick="switchMode('admin')">‚öôÔ∏è Modo Admin</button>
            </div>
        </div>

        <div class="ventas-mode" id="ventasMode">
            <div class="panel">
                <div class="search-box">
                    <input type="text" class="search-input" id="searchInput" placeholder="Buscar scripts..." autocomplete="off">
                    <div class="search-results" id="searchResults"></div>
                </div>
            </div>
            
            <!-- üö¶ SEM√ÅFORO DE CALIFICACI√ìN -->
            <div class="panel">
                <h2>üö¶ Sem√°foro de Calificaci√≥n</h2>
                <div class="semaforo-container">
                    <div class="semaforo-light verde" onclick="handleSemaforoClick('verde')">
                        <div class="semaforo-icon">üü¢</div>
                        <div>
                            <div class="semaforo-title">LUZ VERDE: COTIZAR</div>
                            <div class="semaforo-description">
                                El cliente se siente escuchado, conf√≠a en nosotros y entiende el valor.
                            </div>
                            <ul class="semaforo-list">
                                <li>Entendimos su "porqu√©"</li>
                                <li>Validamos su presupuesto</li>
                                <li>Confirm√≥ que le gusta la idea</li>
                                <li>El decisor est√° involucrado</li>
                            </ul>
                        </div>
                    </div>
                    
                    <div class="semaforo-light amarillo" onclick="handleSemaforoClick('amarillo')">
                        <div class="semaforo-icon">üü°</div>
                        <div>
                            <div class="semaforo-title">LUZ AMARILLA: INVESTIGAR</div>
                            <div class="semaforo-description">
                                A√∫n no entendemos la necesidad real. Es momento de preguntar, no de proponer.
                            </div>
                            <ul class="semaforo-list">
                                <li>Habla solo de precio</li>
                                <li>No tiene claro el objetivo</li>
                                <li>Pide "ideas" sin contexto</li>
                                <li>No es el decisor final</li>
                            </ul>
                        </div>
                    </div>
                    
                    <div class="semaforo-light rojo" onclick="handleSemaforoClick('rojo')">
                        <div class="semaforo-icon">üî¥</div>
                        <div>
                            <div class="semaforo-title">LUZ ROJA: PAUSAR</div>
                            <div class="semaforo-description">
                                Riesgo alto de ser una "cotizaci√≥n fantasma". Invertir tiempo aqu√≠ es costoso.
                            </div>
                            <ul class="semaforo-list">
                                <li>"Solo para tener una idea"</li>
                                <li>Sin presupuesto ni urgencia</li>
                                <li>No responde preguntas clave</li>
                                <li>"Env√≠eme lo que tengas"</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="panel">
                <div class="tabs" id="categoryTabs"></div>
                <div class="tab-content" id="scriptsContainer">
                    <div class="loading">Cargando scripts...</div>
                </div>
            </div>
        </div>

        <div class="admin-mode" id="adminMode">
            <!-- El contenido del modo admin se generar√° aqu√≠ -->
        </div>
    </div>

    <script>
        // ‚úÖ CONFIGURACI√ìN - URLs relativas funcionan perfectamente
        const API_BASE_URL = '';
        
        let SCRIPTS_DATA = {};
        let currentEditingId = null;
        let isAuthenticated = false;
        let debounceTimer = null; // ‚úÖ Inicializaci√≥n corregida
        let connectionInterval = null; // ‚úÖ Para poder limpiar el intervalo

        // ‚úÖ FUNCI√ìN DE ALERTAS MEJORADA
        function showAlert(message, type = 'success', containerId = 'alertContainer') {
            // Buscar contenedor, si no existe intentar crear uno o usar mainContent
            let container = document.getElementById(containerId);
            if (!container) {
                container = document.getElementById('mainContent');
                if (!container) return;
            }
            
            const alertEl = document.createElement('div');
            alertEl.className = `alert ${type}`;
            alertEl.textContent = message;
            container.prepend(alertEl);
            
            // Auto-remover despu√©s de 4 segundos
            setTimeout(() => {
                if (alertEl.parentNode) {
                    alertEl.remove();
                }
            }, 4000);
        }

        // ‚úÖ LLAMADAS A API MEJORADAS
        async function apiCall(endpoint, options = {}) {
            try {
                const url = `${API_BASE_URL}${endpoint}`;
                console.log('API Call:', url); // Para debugging
                
                const response = await fetch(url, {
                    ...options,
                    headers: {
                        'Content-Type': 'application/json',
                        ...options.headers
                    }
                });
                
                updateConnectionStatus(true);
                
                if (!response.ok) {
                    let errorData;
                    try {
                        errorData = await response.json();
                    } catch {
                        errorData = { error: `Error HTTP: ${response.status}` };
                    }
                    throw new Error(errorData.error || `Error HTTP: ${response.status}`);
                }
                
                const contentType = response.headers.get("content-type");
                if (contentType?.includes("application/json")) {
                    return await response.json();
                } else {
                    return await response.blob();
                }
            } catch (error) {
                console.error('API Error:', error);
                updateConnectionStatus(false);
                showAlert(`Error de conexi√≥n: ${error.message}`, 'error');
                throw error;
            }
        }
        
        // ‚úÖ CARGA DE DATOS MEJORADA
        async function fetchAllData() {
            const container = document.getElementById('scriptsContainer');
            if (container) {
                container.innerHTML = '<div class="loading">Cargando scripts...</div>';
            }
            
            try {
                const data = await apiCall('/api/scripts');
                SCRIPTS_DATA = data;
                renderVentasUI();
                updateSystemStatus();
            } catch (error) {
                if (container) {
                    container.innerHTML = `
                        <div class="error-message">
                            ‚ùå Error al cargar scripts: ${error.message}
                            <br><br>
                            <button onclick="fetchAllData()" class="copy-btn">üîÑ Reintentar</button>
                        </div>
                    `;
                }
            }
        }
        
        // ‚úÖ AUTENTICACI√ìN MEJORADA
        function handleAuth(e) {
            e.preventDefault();
            const username = document.getElementById('authUsername')?.value;
            const password = document.getElementById('authPassword')?.value;
            const errorEl = document.getElementById('authError');
            
            if (!username || !password) {
                if (errorEl) {
                    errorEl.textContent = 'Por favor ingresa usuario y contrase√±a';
                    errorEl.style.display = 'block';
                }
                return;
            }
            
            if (username === 'admin' && password === 'DPI2025Admin') {
                isAuthenticated = true;
                document.getElementById('authOverlay')?.classList.remove('active');
                const mainContent = document.getElementById('mainContent');
                if (mainContent) {
                    mainContent.style.filter = 'none';
                }
                switchMode('admin', true);
                
                // Limpiar formulario
                document.getElementById('authForm')?.reset();
                if (errorEl) errorEl.style.display = 'none';
            } else {
                if (errorEl) {
                    errorEl.textContent = 'Usuario o contrase√±a incorrectos';
                    errorEl.style.display = 'block';
                }
            }
        }

        function cancelAuth() {
            const overlay = document.getElementById('authOverlay');
            const mainContent = document.getElementById('mainContent');
            
            if (overlay) overlay.classList.remove('active');
            if (mainContent) mainContent.style.filter = 'none';
            
            // Limpiar formulario
            document.getElementById('authForm')?.reset();
            const errorEl = document.getElementById('authError');
            if (errorEl) errorEl.style.display = 'none';
        }

        function showAuthModal() {
            const overlay = document.getElementById('authOverlay');
            const mainContent = document.getElementById('mainContent');
            
            if (overlay) {
                overlay.classList.add('active');
                if (mainContent) mainContent.style.filter = 'blur(5px)';
                
                setTimeout(() => {
                    const usernameInput = document.getElementById('authUsername');
                    if (usernameInput) usernameInput.focus();
                }, 100);
            }
        }

        // ‚úÖ CAMBIO DE MODO MEJORADO
        function switchMode(mode, fromAuth = false) {
            const ventasMode = document.getElementById('ventasMode');
            const adminMode = document.getElementById('adminMode');
            const modeButtons = document.querySelectorAll('.mode-btn');

            if (mode === 'admin' && !fromAuth) { 
                showAuthModal(); 
                return; 
            }
            
            // Remover clase active de todos los botones
            modeButtons.forEach(btn => btn.classList.remove('active'));
            
            if (mode === 'ventas') {
                if (ventasMode) ventasMode.style.display = 'block';
                if (adminMode) adminMode.style.display = 'none';
                if (modeButtons[0]) modeButtons[0].classList.add('active');
            } else if (mode === 'admin') {
                if (ventasMode) ventasMode.style.display = 'none';
                if (adminMode) adminMode.style.display = 'block';
                if (modeButtons[1]) modeButtons[1].classList.add('active');
                loadAdminData();
            }
        }

        // ‚úÖ RENDERIZADO DE UI MEJORADO
        function renderVentasUI() {
            const tabsContainer = document.getElementById('categoryTabs');
            const scriptsContainer = document.getElementById('scriptsContainer');
            
            if (!tabsContainer || !scriptsContainer) return;
            
            tabsContainer.innerHTML = '';
            scriptsContainer.innerHTML = '';
            
            const categoryNames = {
                bienvenida: "üí¨ Bienvenida", 
                calificacion: "üîç Calificaci√≥n", 
                objeciones: "üõ°Ô∏è Objeciones", 
                seguimiento: "üìû Seguimiento", 
                cierre: "üéØ Cierre"
            };
            
            Object.keys(categoryNames).forEach((category, index) => {
                // Crear tab
                const tab = document.createElement('button');
                tab.className = `tab ${index === 0 ? 'active' : ''}`;
                tab.textContent = categoryNames[category];
                tab.onclick = (e) => showTab(category, e.target);
                tabsContainer.appendChild(tab);
                
                // Crear secci√≥n
                const section = document.createElement('div');
                section.id = category;
                section.className = `tab-section ${index > 0 ? 'hidden' : ''}`;
                
                if (SCRIPTS_DATA[category] && SCRIPTS_DATA[category].length > 0) {
                    section.innerHTML = SCRIPTS_DATA[category].map(createScriptCardHTML).join('');
                } else {
                    section.innerHTML = `<div class="empty-state">No hay scripts en esta categor√≠a.</div>`;
                }
                
                scriptsContainer.appendChild(section);
            });
        }
        
        // ‚úÖ CREACI√ìN DE CARDS MEJORADA
        function createScriptCardHTML(script) {
            const badgeHTML = script.badge ? 
                `<span class="script-badge" style="background-color: ${script.badge.color || '#6c757d'}">
                    ${script.badge.icon} ${script.badge.text}
                </span>` : '';
            
            return `
                <div class="script-card" data-script-id="${script.id}">
                    <div class="script-title">
                        ${script.title}
                        ${badgeHTML}
                    </div>
                    <div class="script-text">${script.text}</div>
                    <div class="usage-stats">
                        <span>üìä ${script.usage_30_days || 0} usos (30d)</span>
                        <span>üìà ${script.usage_7_days || 0} usos (7d)</span>
                    </div>
                    <div class="script-actions">
                        <button class="copy-btn" onclick="copyAndTrack(${script.id})">üìã Copiar</button>
                    </div>
                </div>
            `;
        }
        
        // ‚úÖ NAVEGACI√ìN ENTRE TABS MEJORADA
        function showTab(category, clickedTab) {
            // Remover active de todos los tabs
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            // Ocultar todas las secciones
            document.querySelectorAll('.tab-section').forEach(s => s.classList.add('hidden'));
            
            // Activar tab clickeado
            if (clickedTab) clickedTab.classList.add('active');
            
            // Mostrar secci√≥n correspondiente
            const section = document.getElementById(category);
            if (section) section.classList.remove('hidden');
        }

        // ‚úÖ ESTADO DEL SISTEMA MEJORADO
        function updateSystemStatus() {
            const totalCount = SCRIPTS_DATA ? 
                Object.values(SCRIPTS_DATA).reduce((sum, cat) => 
                    sum + (Array.isArray(cat) ? cat.length : 0), 0
                ) : 0;
            
            const statusEl = document.getElementById('systemStatus');
            if (statusEl) {
                statusEl.className = 'status online';
                statusEl.innerHTML = `‚úÖ Sistema activo - ${totalCount} scripts disponibles - ${new Date().toLocaleTimeString()}`;
            }
        }

        // ‚úÖ ESTADO DE CONEXI√ìN MEJORADO
        function updateConnectionStatus(isOnline) {
            const statusEl = document.getElementById('connectionStatus');
            const headerStatus = document.getElementById('systemStatus');
            
            if (statusEl) {
                statusEl.textContent = isOnline ? 'üü¢ En l√≠nea' : 'üî¥ Sin conexi√≥n';
                statusEl.className = `connection-status ${isOnline ? 'online' : 'offline'}`;
            }
            
            if (headerStatus) {
                headerStatus.className = `status ${isOnline ? 'online' : 'offline'}`;
                if (!isOnline) {
                    headerStatus.textContent = 'üî¥ Error de Servidor';
                }
            }
        }
        
        // ‚úÖ COPIAR Y RASTREAR MEJORADO
        async function copyAndTrack(scriptId) {
            const card = document.querySelector(`.script-card[data-script-id="${scriptId}"]`);
            if (!card) return;
            
            const textElement = card.querySelector('.script-text');
            const button = card.querySelector('.copy-btn');
            
            if (!textElement || !button) return;
            
            const text = textElement.innerText;
            
            try {
                await navigator.clipboard.writeText(text);
                
                // Feedback visual
                const originalText = button.textContent;
                button.textContent = '‚úÖ Copiado';
                button.classList.add('copied');
                
                setTimeout(() => {
                    button.textContent = originalText;
                    button.classList.remove('copied');
                }, 2000);
                
                // Rastrear uso (sin bloquear la UI si falla)
                try {
                    await apiCall(`/api/scripts/${scriptId}/track`, { method: 'POST' });
                } catch (trackError) {
                    console.warn('Error al rastrear uso:', trackError);
                }
                
            } catch (copyError) {
                console.error('Error al copiar:', copyError);
                showAlert('Error al copiar al portapapeles', 'error');
            }
        }

        // ‚úÖ CARGA DE DATOS ADMIN MEJORADA
        function loadAdminData() {
            const adminContainer = document.getElementById('adminMode');
            if (!adminContainer) return;
            
            // Solo crear el HTML si no existe
            if (!adminContainer.querySelector('.admin-controls')) {
                adminContainer.innerHTML = `
                    <div class="panel stats-bar" id="statsBar">
                        <div class="stats-item">
                            <span class="stats-number">---</span>
                            <span class="stats-label">Cargando...</span>
                        </div>
                    </div>
                    
                    <div class="panel">
                        <h2>üìä Analytics</h2>
                        <div id="analyticsContainer">
                            <div class="loading">Cargando analytics...</div>
                        </div>
                    </div>
                    
                    <div class="admin-controls">
                        <div class="panel">
                            <h2 id="formTitle">‚ûï Agregar Script</h2>
                            <div id="alertContainer"></div>
                            <form id="scriptForm">
                                <div class="form-group">
                                    <label>Categor√≠a</label>
                                    <select id="scriptCategory" required>
                                        <option value="">Seleccionar categor√≠a</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>T√≠tulo</label>
                                    <input type="text" id="scriptTitle" required placeholder="Ingresa el t√≠tulo del script">
                                </div>
                                <div class="form-group">
                                    <label>Texto</label>
                                    <textarea id="scriptText" required placeholder="Ingresa el contenido del script"></textarea>
                                </div>
                                <button type="submit" class="admin-btn success">üíæ Guardar</button>
                                <button type="button" class="admin-btn danger" onclick="clearForm()">üóëÔ∏è Limpiar</button>
                            </form>
                        </div>
                        
                        <div class="panel">
                            <h2>üìù Scripts Existentes</h2>
                            <div class="form-group">
                                <label>Filtrar por categor√≠a</label>
                                <select id="filterCategory">
                                    <option value="all">Todas las categor√≠as</option>
                                </select>
                            </div>
                            <div class="scripts-list" id="scriptsList">
                                <div class="loading">Cargando scripts...</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="panel">
                        <h2>üíæ Gesti√≥n de Backups</h2>
                        <div id="backup-controls">
                            <button class="admin-btn success" onclick="downloadBackup()">üì• Descargar Backup</button>
                            <input type="file" id="restoreFile" class="hidden" accept=".db" onchange="restoreFromBackup(this.files[0])">
                            <button class="admin-btn danger" onclick="document.getElementById('restoreFile').click()">üîß Restaurar desde Archivo</button>
                        </div>
                    </div>
                `;
                
                // ‚úÖ ASIGNAR LISTENERS SOLO UNA VEZ
                const scriptForm = document.getElementById('scriptForm');
                if (scriptForm) {
                    scriptForm.addEventListener('submit', handleAdminFormSubmit);
                }
                
                const filterCategory = document.getElementById('filterCategory');
                if (filterCategory) {
                    filterCategory.addEventListener('change', renderAdminList);
                }
            }
            
            // Poblar selects y cargar datos
            populateCategorySelect('scriptCategory');
            populateCategorySelect('filterCategory');
            renderAdminList();
            loadAnalyticsDashboard();
            updateAdminStats();
        }

        // ‚úÖ POBLAR SELECTS MEJORADO
        function populateCategorySelect(selectId) {
            const select = document.getElementById(selectId);
            if (!select) return;
            
            // Guardar valor actual
            const currentValue = select.value;
            
            // Limpiar opciones
            select.innerHTML = '';
            
            // Agregar opci√≥n "Todas" solo para filtro
            if (selectId === 'filterCategory') {
                select.innerHTML = `<option value="all">Todas las categor√≠as</option>`;
            } else {
                select.innerHTML = `<option value="">Seleccionar categor√≠a</option>`;
            }
            
            const categoryNames = {
                bienvenida: "üí¨ Bienvenida", 
                calificacion: "üîç Calificaci√≥n", 
                objeciones: "üõ°Ô∏è Objeciones", 
                seguimiento: "üìû Seguimiento", 
                cierre: "üéØ Cierre"
            };
            
            Object.keys(categoryNames).forEach(key => {
                select.innerHTML += `<option value="${key}">${categoryNames[key]}</option>`;
            });
            
            // Restaurar valor si era v√°lido
            if (currentValue && (currentValue === 'all' || categoryNames[currentValue])) {
                select.value = currentValue;
            }
        }
        
        // ‚úÖ RENDERIZADO LISTA ADMIN MEJORADO
        function renderAdminList() {
            const listContainer = document.getElementById('scriptsList');
            const filterSelect = document.getElementById('filterCategory');
            
            if (!listContainer) return;
            
            const filter = filterSelect ? filterSelect.value : 'all';
            listContainer.innerHTML = '';
            
            let hasScripts = false;
            const categoryNames = {
                bienvenida: "üí¨ Bienvenida", 
                calificacion: "üîç Calificaci√≥n", 
                objeciones: "üõ°Ô∏è Objeciones", 
                seguimiento: "üìû Seguimiento", 
                cierre: "üéØ Cierre"
            };
            
            Object.keys(SCRIPTS_DATA).forEach(category => {
                if (filter === 'all' || filter === category) {
                    if (SCRIPTS_DATA[category] && SCRIPTS_DATA[category].length > 0) {
                        hasScripts = true;
                        
                        // Agregar header de categor√≠a si mostramos todas
                        if (filter === 'all') {
                            listContainer.innerHTML += `
                                <div style="margin: 20px 0 10px 0; font-weight: 600; color: var(--primary-color);">
                                    ${categoryNames[category] || category}
                                </div>
                            `;
                        }
                        
                        SCRIPTS_DATA[category].forEach(script => {
                            listContainer.innerHTML += `
                                <div class="script-item">
                                    <div>
                                        <h4>${script.title}</h4>
                                        <small style="color: #7f8c8d;">${script.text.substring(0, 60)}...</small>
                                    </div>
                                    <div class="script-item-actions">
                                        <button class="edit-btn" onclick="editScript(${script.id})">‚úèÔ∏è Editar</button>
                                        <button class="delete-btn" onclick="deleteScript(${script.id})">üóëÔ∏è Eliminar</button>
                                    </div>
                                </div>
                            `;
                        });
                    }
                }
            });
            
            if (!hasScripts) {
                listContainer.innerHTML = `
                    <div class="empty-state">
                        ${filter === 'all' ? 'No hay scripts disponibles.' : `No hay scripts en la categor√≠a "${categoryNames[filter] || filter}".`}
                    </div>
                `;
            }
        }
        
        // ‚úÖ MANEJO DE FORMULARIO ADMIN MEJORADO
        async function handleAdminFormSubmit(e) {
            e.preventDefault();
            
            const categoryEl = document.getElementById('scriptCategory');
            const titleEl = document.getElementById('scriptTitle');
            const textEl = document.getElementById('scriptText');
            
            if (!categoryEl || !titleEl || !textEl) {
                showAlert('Error: elementos del formulario no encontrados', 'error');
                return;
            }
            
            // Validaciones
            const category = categoryEl.value.trim();
            const title = titleEl.value.trim();
            const text = textEl.value.trim();
            
            if (!category) {
                showAlert('Por favor selecciona una categor√≠a', 'error');
                categoryEl.focus();
                return;
            }
            
            if (!title) {
                showAlert('Por favor ingresa un t√≠tulo', 'error');
                titleEl.focus();
                return;
            }
            
            if (!text) {
                showAlert('Por favor ingresa el texto del script', 'error');
                textEl.focus();
                return;
            }
            
            const payload = { category, title, text };
            const endpoint = currentEditingId ? `/api/scripts/${currentEditingId}` : '/api/scripts';
            const method = currentEditingId ? 'PUT' : 'POST';
            
            try {
                await apiCall(endpoint, { 
                    method, 
                    headers: { 
                        'Content-Type': 'application/json', 
                        'Authorization': 'Bearer DPI2025Admin' 
                    }, 
                    body: JSON.stringify(payload) 
                });
                
                const action = currentEditingId ? 'actualizado' : 'creado';
                showAlert(`Script ${action} exitosamente`, 'success');
                
                clearForm();
                await fetchAllData(); // Recargar todos los datos
                renderAdminList();
                updateAdminStats();
                
            } catch (error) {
                showAlert(`Error al ${currentEditingId ? 'actualizar' : 'crear'} script: ${error.message}`, 'error');
            }
        }

        // ‚úÖ EDICI√ìN MEJORADA
        function editScript(id) {
            let scriptToEdit = null;
            let categoryKey = null;
            
            // Buscar el script en todas las categor√≠as
            for (const category in SCRIPTS_DATA) {
                const found = SCRIPTS_DATA[category].find(s => s.id === id);
                if (found) {
                    scriptToEdit = found;
                    categoryKey = category;
                    break;
                }
            }
            
            if (!scriptToEdit) {
                showAlert('Script no encontrado', 'error');
                return;
            }
            
            // Actualizar estado
            currentEditingId = id;
            
            // Actualizar UI
            const formTitle = document.getElementById('formTitle');
            const categorySelect = document.getElementById('scriptCategory');
            const titleInput = document.getElementById('scriptTitle');
            const textArea = document.getElementById('scriptText');
            
            if (formTitle) formTitle.textContent = `‚úèÔ∏è Editando: ${scriptToEdit.title}`;
            if (categorySelect) categorySelect.value = categoryKey;
            if (titleInput) titleInput.value = scriptToEdit.title;
            if (textArea) textArea.value = scriptToEdit.text;
            
            // Scroll al formulario
            if (formTitle) {
                formTitle.scrollIntoView({ behavior: 'smooth' });
            }
        }
        
        // ‚úÖ ELIMINACI√ìN MEJORADA
        async function deleteScript(id) {
            // Buscar el script para mostrar su t√≠tulo
            let scriptTitle = `ID ${id}`;
            for (const category in SCRIPTS_DATA) {
                const found = SCRIPTS_DATA[category].find(s => s.id === id);
                if (found) {
                    scriptTitle = found.title;
                    break;
                }
            }
            
            if (!confirm(`¬øEst√°s seguro de que quieres eliminar el script "${scriptTitle}"?\n\nEsta acci√≥n no se puede deshacer.`)) {
                return;
            }
            
            try {
                await apiCall(`/api/scripts/${id}`, { 
                    method: 'DELETE', 
                    headers: { 'Authorization': 'Bearer DPI2025Admin' } 
                });
                
                showAlert('Script eliminado exitosamente', 'success');
                await fetchAllData(); // Recargar todos los datos
                renderAdminList();
                updateAdminStats();
                
            } catch (error) {
                showAlert(`Error al eliminar script: ${error.message}`, 'error');
            }
        }

        // ‚úÖ LIMPIAR FORMULARIO MEJORADO
        function clearForm() {
            currentEditingId = null;
            
            const form = document.getElementById('scriptForm');
            const formTitle = document.getElementById('formTitle');
            
            if (form) form.reset();
            if (formTitle) formTitle.textContent = '‚ûï Agregar Script';
            
            // Limpiar alertas
            const alertContainer = document.getElementById('alertContainer');
            if (alertContainer) {
                alertContainer.innerHTML = '';
            }
        }

        // ‚úÖ ANALYTICS MEJORADO
        async function loadAnalyticsDashboard() {
            const container = document.getElementById('analyticsContainer');
            if (!container) return;
            
            container.innerHTML = '<div class="loading">Cargando analytics...</div>';
            
            try {
                const data = await apiCall('/api/analytics', { 
                    headers: { 'Authorization': 'Bearer DPI2025Admin' } 
                });
                
                let html = '<div style="display: grid; gap: 20px;">';
                
                // Top Scripts
                html += '<div><h4>üèÜ Scripts M√°s Usados (30 d√≠as)</h4>';
                if (data.topScripts && data.topScripts.length > 0) {
                    data.topScripts.forEach((script, index) => {
                        html += `
                            <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid var(--border-color);">
                                <span>${index + 1}. ${script.title}</span>
                                <strong>${script.uses_30_days} usos</strong>
                            </div>
                        `;
                    });
                } else {
                    html += '<div style="color: #7f8c8d; font-style: italic;">No hay datos disponibles</div>';
                }
                html += '</div>';
                
                // Category Stats
                html += '<div><h4>üìä Uso por Categor√≠a (30 d√≠as)</h4>';
                if (data.categoryStats && data.categoryStats.length > 0) {
                    const categoryNames = {
                        bienvenida: "üí¨ Bienvenida", 
                        calificacion: "üîç Calificaci√≥n", 
                        objeciones: "üõ°Ô∏è Objeciones", 
                        seguimiento: "üìû Seguimiento", 
                        cierre: "üéØ Cierre"
                    };
                    
                    data.categoryStats.forEach(stat => {
                        html += `
                            <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid var(--border-color);">
                                <span>${categoryNames[stat.category] || stat.category}</span>
                                <strong>${stat.usage_count} usos</strong>
                            </div>
                        `;
                    });
                } else {
                    html += '<div style="color: #7f8c8d; font-style: italic;">No hay datos disponibles</div>';
                }
                html += '</div></div>';
                
                container.innerHTML = html;
                
            } catch (error) {
                container.innerHTML = `
                    <div class="error-message">
                        ‚ùå Error al cargar analytics: ${error.message}
                        <br><br>
                        <button onclick="loadAnalyticsDashboard()" class="copy-btn">üîÑ Reintentar</button>
                    </div>
                `;
            }
        }

        // ‚úÖ ESTAD√çSTICAS ADMIN MEJORADAS
        function updateAdminStats() {
            const statsBar = document.getElementById('statsBar');
            if (!statsBar) return;
            
            const totalScripts = SCRIPTS_DATA ? 
                Object.values(SCRIPTS_DATA).reduce((sum, category) => 
                    sum + (Array.isArray(category) ? category.length : 0), 0
                ) : 0;
            
            const lastUpdate = new Date().toLocaleTimeString();
            
            statsBar.innerHTML = `
                <div class="stats-item">
                    <span class="stats-number">${totalScripts}</span>
                    <span class="stats-label">Scripts Totales</span>
                </div>
                <div class="stats-item">
                    <span class="stats-number">${Object.keys(SCRIPTS_DATA).length}</span>
                    <span class="stats-label">Categor√≠as</span>
                </div>
                <div class="stats-item">
                    <span class="stats-number">${lastUpdate}</span>
                    <span class="stats-label">√öltima Actualizaci√≥n</span>
                </div>
                <div class="stats-item">
                    <span class="stats-number">‚úÖ</span>
                    <span class="stats-label">Estado Sistema</span>
                </div>
            `;
        }
        
        // ‚úÖ BACKUPS MEJORADOS
        async function downloadBackup() {
            try {
                const blob = await apiCall('/api/backup', { 
                    headers: { 'Authorization': 'Bearer DPI2025Admin' } 
                });
                
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `dpi-backup-${new Date().toISOString().split('T')[0]}.db`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);
                
                showAlert('Backup descargado exitosamente', 'success');
                
            } catch (error) {
                showAlert(`Error al descargar backup: ${error.message}`, 'error');
            }
        }
        
        async function restoreFromBackup(file) {
            if (!file) return;
            
            if (!file.name.endsWith('.db')) {
                showAlert('Por favor selecciona un archivo .db v√°lido', 'error');
                return;
            }
            
            const confirmMessage = `üö® ADVERTENCIA IMPORTANTE üö®

¬øEst√°s completamente seguro de que quieres restaurar desde este backup?

Esta acci√≥n:
‚Ä¢ Reemplazar√° TODA la base de datos actual
‚Ä¢ Eliminar√° todos los scripts existentes
‚Ä¢ No se puede deshacer

Archivo: ${file.name}
Tama√±o: ${(file.size / 1024).toFixed(2)} KB

¬øContinuar con la restauraci√≥n?`;
            
            if (!confirm(confirmMessage)) {
                // Limpiar el input file
                const fileInput = document.getElementById('restoreFile');
                if (fileInput) fileInput.value = '';
                return;
            }
            
            const formData = new FormData();
            formData.append('backup', file);
            
            try {
                const result = await apiCall('/api/restore', { 
                    method: 'POST', 
                    headers: { 'Authorization': 'Bearer DPI2025Admin' }, 
                    body: formData 
                });
                
                showAlert(result.message || 'Restauraci√≥n exitosa', 'success');
                
                // Esperar un poco y recargar la p√°gina
                setTimeout(() => {
                    window.location.reload();
                }, 2000);
                
            } catch (error) {
                showAlert(`Error al restaurar backup: ${error.message}`, 'error');
            } finally {
                // Limpiar el input file
                const fileInput = document.getElementById('restoreFile');
                if (fileInput) fileInput.value = '';
            }
        }
        
        // ‚úÖ B√öSQUEDA MEJORADA
        function performSearch(query) {
            const resultsContainer = document.getElementById('searchResults');
            if (!resultsContainer) return;
            
            resultsContainer.innerHTML = `<div class="loading" style="padding:10px;">Buscando...</div>`;
            resultsContainer.classList.add('active');
            
            // Cancelar b√∫squeda anterior si existe
            if (window.searchController) {
                window.searchController.abort();
            }
            
            // Crear nuevo AbortController para esta b√∫squeda
            window.searchController = new AbortController();
            
            apiCall(`/api/scripts/search?q=${encodeURIComponent(query)}`, {
                signal: window.searchController.signal
            })
                .then(results => {
                    if (!results || !Array.isArray(results)) {
                        resultsContainer.innerHTML = `<div class="search-result-item error-message">Error en formato de respuesta</div>`;
                        return;
                    }
                    
                    if (results.length > 0) {
                        resultsContainer.innerHTML = results.map(result => `
                            <div class="search-result-item" onclick="scrollToScript(${result.id})">
                                <div class="search-result-category">${getCategoryName(result.category)}</div>
                                <div>${result.highlightedTitle}</div>
                                <div style="font-size: 0.8em; color: #7f8c8d; margin-top: 5px;">${result.highlightedText || ''}</div>
                            </div>
                        `).join('');
                    } else {
                        resultsContainer.innerHTML = `
                            <div class="search-result-item" style="text-align: center; color: #7f8c8d;">
                                üîç No se encontraron resultados para "${query}"
                            </div>
                        `;
                    }
                })
                .catch(error => {
                    if (error.name === 'AbortError') return; // B√∫squeda cancelada
                    
                    resultsContainer.innerHTML = `
                        <div class="search-result-item error-message">
                            ‚ùå Error en la b√∫squeda: ${error.message}
                        </div>
                    `;
                });
        }
        
        function getCategoryName(category) {
            const categoryNames = {
                bienvenida: "üí¨ Bienvenida", 
                calificacion: "üîç Calificaci√≥n", 
                objeciones: "üõ°Ô∏è Objeciones", 
                seguimiento: "üìû Seguimiento", 
                cierre: "üéØ Cierre"
            };
            return categoryNames[category] || category;
        }
        
        // ‚úÖ MANEJO DEL SEM√ÅFORO DE CALIFICACI√ìN
        function handleSemaforoClick(color) {
            const categoryMap = {
                'verde': 'cierre',      // Cliente listo ‚Üí Scripts de cierre
                'amarillo': 'calificacion', // Necesita investigaci√≥n ‚Üí Scripts de calificaci√≥n
                'rojo': 'bienvenida'    // Cliente problem√°tico ‚Üí Scripts b√°sicos de bienvenida
            };
            
            const targetCategory = categoryMap[color];
            
            // Mostrar feedback visual
            const messages = {
                'verde': 'üü¢ Cliente LISTO para cotizar ‚Üí Ir a scripts de CIERRE',
                'amarillo': 'üü° Cliente necesita INVESTIGACI√ìN ‚Üí Ir a scripts de CALIFICACI√ìN', 
                'rojo': 'üî¥ Cliente PROBLEM√ÅTICO ‚Üí Usar scripts b√°sicos de BIENVENIDA'
            };
            
            showAlert(messages[color], 'success');
            
            // Navegar a la categor√≠a correspondiente despu√©s de un peque√±o delay
            setTimeout(() => {
                const tabs = Array.from(document.querySelectorAll('.tab'));
                const targetTab = tabs.find(tab => {
                    const tabText = tab.textContent.toLowerCase();
                    return tabText.includes(targetCategory);
                });
                
                if (targetTab) {
                    showTab(targetCategory, targetTab);
                    
                    // Scroll suave hacia los scripts
                    setTimeout(() => {
                        document.getElementById('categoryTabs').scrollIntoView({ 
                            behavior: 'smooth' 
                        });
                    }, 100);
                }
            }, 1500);
        }
        function scrollToScript(id) {
            const searchResults = document.getElementById('searchResults');
            if (searchResults) {
                searchResults.classList.remove('active');
            }
            
            // Limpiar input de b√∫squeda
            const searchInput = document.getElementById('searchInput');
            if (searchInput) {
                searchInput.value = '';
            }
            
            const card = document.querySelector(`.script-card[data-script-id="${id}"]`);
            if (!card) {
                showAlert('Script no encontrado en la vista actual', 'error');
                return;
            }
            
            // Encontrar la categor√≠a del script
            let categoryKey = null;
            for (const category in SCRIPTS_DATA) {
                if (SCRIPTS_DATA[category].some(s => s.id == id)) {
                    categoryKey = category;
                    break;
                }
            }
            
            if (categoryKey) {
                // Cambiar a la tab correcta
                const tabs = Array.from(document.querySelectorAll('.tab'));
                const targetTab = tabs.find(tab => {
                    const tabText = tab.textContent.toLowerCase();
                    return tabText.includes(categoryKey) || 
                           tabText.includes(getCategoryName(categoryKey).toLowerCase());
                });
                
                if (targetTab) {
                    showTab(categoryKey, targetTab);
                }
            }
            
            // Scroll y highlight despu√©s de un peque√±o delay
            setTimeout(() => {
                card.scrollIntoView({ behavior: 'smooth', block: 'center' });
                
                // Efecto de highlight
                card.style.transition = 'background-color 0.5s ease';
                card.style.backgroundColor = '#fff3cd';
                
                setTimeout(() => {
                    card.style.backgroundColor = '';
                }, 2000);
            }, 100);
        }

        // ‚úÖ MANEJO DEL SEM√ÅFORO DE CALIFICACI√ìN
        function handleSemaforoClick(color) {
            const categoryMap = {
                'verde': 'cierre',      // Cliente listo ‚Üí Scripts de cierre
                'amarillo': 'calificacion', // Necesita investigaci√≥n ‚Üí Scripts de calificaci√≥n
                'rojo': 'bienvenida'    // Cliente problem√°tico ‚Üí Scripts b√°sicos de bienvenida
            };
            
            const targetCategory = categoryMap[color];
            
            // Mostrar feedback visual
            const messages = {
                'verde': 'üü¢ Cliente LISTO para cotizar ‚Üí Ir a scripts de CIERRE',
                'amarillo': 'üü° Cliente necesita INVESTIGACI√ìN ‚Üí Ir a scripts de CALIFICACI√ìN', 
                'rojo': 'üî¥ Cliente PROBLEM√ÅTICO ‚Üí Usar scripts b√°sicos de BIENVENIDA'
            };
            
            showAlert(messages[color], 'success');
            
            // Navegar a la categor√≠a correspondiente despu√©s de un peque√±o delay
            setTimeout(() => {
                const tabs = Array.from(document.querySelectorAll('.tab'));
                const targetTab = tabs.find(tab => {
                    const tabText = tab.textContent.toLowerCase();
                    return tabText.includes(targetCategory);
                });
                
                if (targetTab) {
                    showTab(targetCategory, targetTab);
                    
                    // Scroll suave hacia los scripts
                    setTimeout(() => {
                        document.getElementById('categoryTabs').scrollIntoView({ 
                            behavior: 'smooth' 
                        });
                    }, 100);
                }
            }, 1500);
        }

        // ‚úÖ INICIALIZACI√ìN MEJORADA
        document.addEventListener('DOMContentLoaded', () => {
            console.log('üöÄ Iniciando DPI Sistema de Ventas...');
            console.log('üåê API Base URL:', API_BASE_URL);
            
            // Configurar formulario de autenticaci√≥n
            const authForm = document.getElementById('authForm');
            if (authForm) {
                authForm.addEventListener('submit', handleAuth);
            }
            
            // Configurar b√∫squeda con debounce
            const searchInput = document.getElementById('searchInput');
            if (searchInput) {
                searchInput.addEventListener('input', (e) => {
                    // Limpiar timer anterior
                    if (debounceTimer) {
                        clearTimeout(debounceTimer);
                    }
                    
                    debounceTimer = setTimeout(() => {
                        const query = e.target.value.trim();
                        const searchResults = document.getElementById('searchResults');
                        
                        if (query.length > 1) {
                            performSearch(query);
                        } else {
                            if (searchResults) {
                                searchResults.classList.remove('active');
                            }
                        }
                    }, 300);
                });
            }

            // Cerrar b√∫squeda al hacer click fuera
            document.addEventListener('click', (e) => {
                const searchBox = e.target.closest('.search-box');
                if (!searchBox) {
                    const searchResults = document.getElementById('searchResults');
                    if (searchResults) {
                        searchResults.classList.remove('active');
                    }
                }
            });

            // Cargar datos iniciales
            fetchAllData();
            
            // Configurar monitoreo de conexi√≥n
            connectionInterval = setInterval(() => {
                updateConnectionStatus(navigator.onLine);
            }, 10000);
            
            // Listener para cambios de conectividad
            window.addEventListener('online', () => updateConnectionStatus(true));
            window.addEventListener('offline', () => updateConnectionStatus(false));
            
            console.log('‚úÖ Sistema inicializado correctamente');
        });

        // ‚úÖ LIMPIEZA AL CERRAR
        window.addEventListener('beforeunload', () => {
            if (connectionInterval) {
                clearInterval(connectionInterval);
            }
            if (debounceTimer) {
                clearTimeout(debounceTimer);
            }
            if (window.searchController) {
                window.searchController.abort();
            }
        });
    </script>
</body>
</html>
