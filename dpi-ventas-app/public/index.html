<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DPI Publicidad - Sistema de Ventas Profesional</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #0FA795; --secondary: #8BC34A; --danger: #dc3545; --warning: #ffc107; 
            --info: #17a2b8; --success: #28a745; --dark: #2c3e50; --light: #ffffff; 
            --bg: #f4f7f6; --border: #e3e8ee;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Inter', sans-serif; background: var(--bg); min-height: 100vh; 
            padding: 10px; font-size: 15px; color: var(--dark); 
        }

        /* üé® UTILIDADES BASE */
        .container { max-width: 1400px; margin: 0 auto; transition: filter 0.3s ease; }
        .panel { background: var(--light); border-radius: 12px; padding: 20px; box-shadow: 0 8px 25px rgba(0,0,0,0.06); margin-bottom: 20px; }
        .panel h2 { font-size: 1.3em; font-weight: 600; margin-bottom: 15px; border-bottom: 2px solid var(--border); padding-bottom: 10px; }
        .loading, .empty-state { text-align: center; padding: 40px 20px; color: #7f8c8d; }
        .hidden { display: none; }
        .grid { display: grid; gap: 15px; }
        .flex { display: flex; }
        .flex-between { display: flex; justify-content: space-between; align-items: center; }
        .flex-center { display: flex; justify-content: center; align-items: center; }
        .btn { border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-weight: 600; transition: all 0.3s ease; font-size: 0.85em; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-success { background: var(--success); color: white; }
        .btn-danger { background: var(--danger); color: white; }
        .btn-warning { background: var(--warning); color: white; }
        .btn:hover { transform: translateY(-1px); box-shadow: 0 3px 10px rgba(0,0,0,0.2); }

        /* üì± HEADER */
        .header { text-align: center; color: var(--dark); margin-bottom: 20px; }
        .header h1 { font-size: 2em; font-weight: 700; margin-bottom: 8px; }
        .header p { font-size: 1em; color: #7f8c8d; }
        .status { background: rgba(0,0,0,0.05); padding: 6px 16px; border-radius: 20px; font-size: 0.85em; margin-top: 10px; display: inline-block; transition: all 0.3s ease; border: 1px solid var(--border); }
        .status.online { background: var(--success); color: white; border-color: var(--success); }
        .status.offline { background: var(--danger); color: white; border-color: var(--danger); }

        /* üéõÔ∏è MODE SWITCHER */
        .mode-switcher-wrapper { text-align: center; margin-bottom: 20px; }
        .mode-switcher { background: #e0e5ec; border-radius: 30px; display: inline-flex; padding: 4px; box-shadow: inset 3px 3px 6px #caced4, inset -3px -3px 6px #f8f9fa; }
        .mode-btn { background: transparent; color: #555; border: none; padding: 8px 20px; border-radius: 25px; font-weight: 600; cursor: pointer; transition: all 0.3s ease; font-size: 0.9em; }
        .mode-btn.active { background: var(--primary); color: white; box-shadow: 0 4px 15px rgba(15, 167, 149, 0.3); }

        /* üîç B√öSQUEDA */
        .search-box { position: relative; padding-bottom: 15px; }
        .search-input { width: 100%; padding: 12px 15px 12px 40px; border: 2px solid var(--border); border-radius: 10px; font-size: 0.95em; }
        .search-input:focus { outline: none; border-color: var(--primary); }
        .search-box::before { content: 'üîç'; position: absolute; left: 15px; top: 12px; color: #aaa; font-size: 1.1em; pointer-events: none; }
        .search-results { position: absolute; top: calc(100% - 5px); left: 0; right: 0; background: var(--light); border: 1px solid var(--border); border-radius: 8px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); max-height: 300px; overflow-y: auto; z-index: 1000; display: none; }
        .search-results.active { display: block; }
        .search-result-item { padding: 10px 12px; border-bottom: 1px solid #f1f3f4; cursor: pointer; font-size: 0.9em; }
        .search-result-item:hover { background: var(--bg); }
        .search-result-category { font-size: 0.75em; color: var(--primary); font-weight: 600; text-transform: uppercase; }

        /* üö¶ SEM√ÅFORO */
        .semaforo-container { display: grid; grid-template-columns: 1fr; gap: 15px; margin-bottom: 20px; }
        .semaforo-light { border-radius: 12px; padding: 20px; color: white; font-weight: 600; position: relative; min-height: 160px; display: flex; flex-direction: column; justify-content: space-between; transition: transform 0.3s ease; cursor: pointer; }
        .semaforo-light:hover { transform: translateY(-3px); }
        .semaforo-light.verde { background: linear-gradient(135deg, #4CAF50, #66BB6A); box-shadow: 0 6px 20px rgba(76, 175, 80, 0.3); }
        .semaforo-light.amarillo { background: linear-gradient(135deg, #FF9800, #FFB74D); box-shadow: 0 6px 20px rgba(255, 152, 0, 0.3); }
        .semaforo-light.rojo { background: linear-gradient(135deg, #F44336, #EF5350); box-shadow: 0 6px 20px rgba(244, 67, 54, 0.3); }
        .semaforo-icon { width: 35px; height: 35px; border-radius: 50%; background: rgba(255, 255, 255, 0.3); display: flex; align-items: center; justify-content: center; font-size: 1.3em; margin-bottom: 12px; }
        .semaforo-title { font-size: 1.2em; font-weight: 700; margin-bottom: 8px; }
        .semaforo-description { font-style: italic; margin-bottom: 15px; opacity: 0.95; line-height: 1.3; font-size: 0.95em; }
        .semaforo-list { list-style: none; padding: 0; margin: 0; }
        .semaforo-list li { padding: 4px 0; display: flex; align-items: center; gap: 6px; font-size: 0.9em; }
        .semaforo-list li::before { content: '‚úì'; font-weight: bold; }
        .amarillo .semaforo-list li::before { content: '!'; }
        .rojo .semaforo-list li::before { content: '‚Ä¢'; }

        /* üìã PROCESO */
        .precalificacion-header { text-align: center; margin-bottom: 20px; padding: 15px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 10px; color: white; }
        .proceso-btn { background: rgba(255, 255, 255, 0.2); color: white; border: 2px solid white; padding: 10px 25px; border-radius: 20px; font-weight: 600; cursor: pointer; transition: all 0.3s ease; }
        .proceso-btn:hover { background: white; color: #667eea; }
        .etapas-container { display: grid; gap: 20px; }
        .etapa { background: var(--bg); border-radius: 10px; padding: 15px; border: 1px solid var(--border); transition: all 0.3s ease; }
        .etapa:hover { transform: translateY(-2px); box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .etapa-header { display: flex; align-items: center; gap: 12px; margin-bottom: 12px; padding-bottom: 12px; border-bottom: 2px solid var(--border); }
        .etapa-numero { background: var(--primary); color: white; width: 35px; height: 35px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; }
        .etapa-tiempo { background: var(--warning); color: white; padding: 4px 10px; border-radius: 12px; font-size: 0.75em; font-weight: 600; }

        /* üìù SCRIPTS */
        .tabs { display: flex; border-bottom: 2px solid var(--border); margin-bottom: 10px; overflow-x: auto; }
        .tab { padding: 8px 14px; background: none; border: none; cursor: pointer; font-weight: 600; font-size: 0.8em; color: #7f8c8d; position: relative; white-space: nowrap; }
        .tab:after { content: ''; position: absolute; bottom: -2px; left: 0; right: 0; height: 3px; background: var(--primary); transform: scaleX(0); transition: transform 0.3s ease; }
        .tab.active { color: var(--primary); }
        .tab.active:after { transform: scaleX(1); }
        .scripts-grid { display: grid; grid-template-columns: 1fr; gap: 12px; margin-top: 15px; }
        .script-card { background: var(--bg); border: 1px solid var(--border); border-radius: 8px; padding: 12px; transition: all 0.3s ease; display: flex; flex-direction: column; }
        .script-card:hover { transform: translateY(-2px); box-shadow: 0 4px 15px rgba(0,0,0,0.1); border-color: var(--primary); }
        .script-title { font-weight: 600; font-size: 0.95em; color: var(--dark); display: flex; align-items: center; gap: 6px; margin-bottom: 8px; }
        .script-text { line-height: 1.4; margin: 8px 0; white-space: pre-line; font-size: 0.85em; flex: 1; color: #555; }
        .script-badge { padding: 2px 6px; border-radius: 8px; font-size: 0.65em; color: white; white-space: nowrap; }
        .copy-btn { background: var(--primary); color: white; border: none; padding: 6px 12px; border-radius: 5px; cursor: pointer; font-weight: 600; transition: all 0.3s ease; font-size: 0.8em; width: 100%; }
        .copy-btn:hover { background: var(--secondary); }
        .copy-btn.copied { background: var(--success); }

        /* üë§ CLIENTES */
        .filtros-cliente { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px; padding: 15px; background: var(--bg); border-radius: 8px; border: 1px solid var(--border); }
        .filtro-grupo { display: flex; flex-direction: column; gap: 5px; }
        .filtro-grupo label { font-weight: 600; font-size: 0.85em; color: var(--dark); }
        .filtro-grupo select { padding: 6px 8px; border: 1px solid var(--border); border-radius: 5px; font-size: 0.85em; background: white; }
        .view-controls { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding: 15px; background: var(--bg); border-radius: 8px; border: 1px solid var(--border); flex-wrap: wrap; gap: 10px; }
        .view-toggle { display: flex; background: #e0e5ec; border-radius: 20px; padding: 3px; }
        .view-toggle-btn { background: transparent; border: none; padding: 6px 12px; border-radius: 17px; cursor: pointer; font-size: 0.8em; font-weight: 600; color: #666; transition: all 0.3s ease; }
        .view-toggle-btn.active { background: var(--primary); color: white; box-shadow: 0 2px 8px rgba(15, 167, 149, 0.3); }
        .perfil-card-enhanced { background: white; border: 1px solid var(--border); border-radius: 12px; padding: 18px; margin-bottom: 15px; transition: all 0.3s ease; cursor: pointer; position: relative; overflow: hidden; }
        .perfil-card-enhanced:hover { box-shadow: 0 8px 25px rgba(0,0,0,0.12); transform: translateY(-3px); border-color: var(--primary); }
        .badge-smart { padding: 4px 10px; border-radius: 15px; font-size: 0.7em; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; }
        .badge-tipo { background: linear-gradient(135deg, #667eea, #764ba2); color: white; }
        .badge-presupuesto.alto { background: linear-gradient(135deg, #28a745, #20c997); color: white; }
        .badge-presupuesto.medio { background: linear-gradient(135deg, #ffc107, #fd7e14); color: white; }
        .badge-presupuesto.bajo { background: linear-gradient(135deg, #6c757d, #495057); color: white; }

        /* üîê AUTH */
        .auth-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); backdrop-filter: blur(8px); z-index: 9999; display: none; justify-content: center; align-items: center; }
        .auth-overlay.active { display: flex; }
        .auth-modal { background: var(--light); border-radius: 12px; padding: 30px; width: 90%; max-width: 350px; text-align: center; box-shadow: 0 15px 40px rgba(0,0,0,0.2); }
        .auth-input { width: 100%; padding: 12px; margin-bottom: 8px; border: 2px solid var(--border); border-radius: 6px; font-size: 0.9em; }

        /* üìä ADMIN */
        .admin-controls { display: grid; grid-template-columns: 1fr; gap: 20px; }
        .form-group { margin-bottom: 12px; }
        .form-group label { display: block; font-weight: 600; margin-bottom: 6px; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 10px; border: 2px solid var(--border); border-radius: 6px; font-size: 0.9em; }
        .form-group textarea { height: 120px; resize: vertical; }
        .scripts-list { max-height: 400px; overflow-y: auto; }
        .script-item { display: flex; justify-content: space-between; align-items: center; padding: 12px; background: var(--bg); border-radius: 6px; margin-bottom: 8px; }

        /* üì± RESPONSIVE */
        @media (min-width: 768px) {
            body { padding: 20px; }
            .header h1 { font-size: 2.5em; }
            .panel { padding: 25px; }
            .semaforo-container { grid-template-columns: 1fr 1fr 1fr; gap: 20px; }
            .scripts-grid { grid-template-columns: 1fr 1fr; }
            .admin-controls { grid-template-columns: 1fr 1.2fr; }
        }
        @media (min-width: 1200px) {
            .scripts-grid { grid-template-columns: 1fr 1fr 1fr; }
        }
        @media (max-width: 480px) {
            body { padding: 5px; }
            .panel { padding: 15px; }
            .semaforo-container { gap: 10px; }
            .tab { padding: 6px 10px; font-size: 0.75em; }
        }

        /* üé® ANIMACIONES */
        @keyframes spin { to { transform: rotate(360deg); } }
        .loading::after { content: ''; display: inline-block; width: 20px; height: 20px; border: 3px solid rgba(0,0,0,0.1); border-top-color: var(--primary); border-radius: 50%; animation: spin 1s linear infinite; margin-left: 10px; }
        
        /* üåà ALERTS */
        .alert { padding: 10px; border-radius: 5px; margin-bottom: 12px; font-weight: bold; font-size: 0.9em; }
        .alert.success { background: #d4edda; color: #155724; }
        .alert.error { background: #f8d7da; color: #721c24; }
        
        /* üîó CONNECTION STATUS */
        .connection-status { position: fixed; bottom: 8px; right: 8px; padding: 6px 12px; border-radius: 15px; z-index: 1000; font-weight: 600; font-size: 0.8em; }
        .connection-status.online { background: #d4edda; color: #155724; }
        .connection-status.offline { background: #f8d7da; color: #721c24; }
    </style>
</head>
<body>
    <div id="connectionStatus" class="connection-status offline">üî¥ Conectando...</div>
    
    <div class="auth-overlay" id="authOverlay">
        <div class="auth-modal">
            <h2>üîê Acceso Administrativo</h2>
            <p>Ingresa tus credenciales para continuar</p>
            <div id="authError" class="alert error" style="display: none;">Usuario o contrase√±a incorrectos</div>
            <form id="authForm">
                <input type="text" id="authUsername" class="auth-input" placeholder="Usuario" required>
                <input type="password" id="authPassword" class="auth-input" placeholder="Contrase√±a" required>
                <button type="submit" class="btn btn-success">Ingresar</button>
                <button type="button" class="btn btn-danger" onclick="cancelAuth()">Cancelar</button>
            </form>
        </div>
    </div>

    <div class="container" id="mainContent">
        <div class="header">
            <h1>DPI Publicidad - Sistema Scripts de Venta</h1>
            <p>R√≥tulos ‚Ä¢ Material POP ‚Ä¢ Stands ‚Ä¢ Banners ‚Ä¢ Viniles</p>
            <div class="status" id="systemStatus">Conectando al servidor...</div>
        </div>

        <div class="mode-switcher-wrapper">
            <div class="mode-switcher">
                <button class="mode-btn active" onclick="switchMode('ventas')" id="ventasModeBtn">üì± Modo Ventas</button>
                <button class="mode-btn" onclick="switchMode('admin')" id="adminModeBtn">‚öôÔ∏è Modo Admin</button>
            </div>
        </div>

        <div class="ventas-mode" id="ventasMode">
            <div class="panel">
                <div class="search-box">
                    <input type="text" class="search-input" id="searchInput" placeholder="Buscar scripts..." autocomplete="off">
                    <div class="search-results" id="searchResults"></div>
                </div>
            </div>
            
            <!-- üö¶ SEM√ÅFORO -->
            <div class="panel">
                <h2>üö¶ Sem√°foro de Calificaci√≥n</h2>
                <div class="precalificacion-header">
                    <p><strong>‚ö†Ô∏è IMPORTANTE:</strong> Completa esta pre-calificaci√≥n antes de hacer cotizaci√≥n formal</p>
                    <button class="proceso-btn" onclick="iniciarProceso()">üéØ Iniciar Proceso de Calificaci√≥n</button>
                </div>
                <div class="semaforo-container" id="semaforoContainer"></div>
            </div>

            <!-- üìã PROCESO -->
            <div class="panel" id="procesoPanel" style="display: none;">
                <h2>üìã Proceso de Calificaci√≥n por Etapas</h2>
                <div class="etapas-container" id="etapasContainer"></div>
                <div class="flex-between" style="margin-top: 25px; padding-top: 15px; border-top: 2px solid var(--border);">
                    <button class="btn btn-danger" onclick="cerrarProceso()">‚ùå Cerrar Proceso</button>
                    <div style="font-weight: 600; color: var(--info);">‚è±Ô∏è Tiempo total estimado: 12-18 minutos</div>
                </div>
            </div>
            
            <!-- üìù SCRIPTS -->
            <div class="panel">
                <h2>üìù Biblioteca de Scripts de Ventas</h2>
                <div style="background: rgba(15, 167, 149, 0.1); padding: 12px 16px; border-radius: 8px; margin-bottom: 15px; border-left: 4px solid var(--primary);">
                    <strong>üí° Prop√≥sito:</strong> Scripts probados y validados para cada etapa del proceso de venta.
                </div>
                <div class="tabs" id="categoryTabs"></div>
                <div class="tab-content" id="scriptsContainer">
                    <div class="loading">Cargando scripts...</div>
                </div>
            </div>

            <!-- üë§ CLIENTES -->
            <div class="panel">
                <h2>üë§ Base de Conocimiento - Perfiles de Clientes Ideales</h2>
                <div class="flex-between" style="margin-bottom: 15px;">
                    <h3>üéØ Perfiles de Clientes IDEALES</h3>
                    <button class="btn btn-primary" onclick="abrirFormularioCliente()">‚ûï Agregar Perfil</button>
                </div>
                
                <div class="filtros-cliente">
                    <div class="filtro-grupo">
                        <label>üè¢ Sector:</label>
                        <select id="filtroTipo" onchange="filtrarPerfiles()">
                            <option value="">Todos los sectores</option>
                            <option value="restaurante">üçΩÔ∏è Restaurantes</option>
                            <option value="retail">üè™ Retail/Tiendas</option>
                            <option value="servicios">üíº Servicios</option>
                            <option value="clinica">üè• Cl√≠nicas</option>
                            <option value="empresa">üè¢ Empresas</option>
                            <option value="otro">üìã Otros</option>
                        </select>
                    </div>
                    <div class="filtro-grupo">
                        <label>üí∞ Presupuesto:</label>
                        <select id="filtroPresupuesto" onchange="filtrarPerfiles()">
                            <option value="">Todos los rangos</option>
                            <option value="bajo">üíµ Bajo ($500-$2K)</option>
                            <option value="medio">üí¥ Medio ($2K-$5K)</option>
                            <option value="alto">üí∏ Alto ($5K+)</option>
                        </select>
                    </div>
                    <div class="filtro-grupo">
                        <label>‚ö° Decisi√≥n:</label>
                        <select id="filtroUrgencia" onchange="filtrarPerfiles()">
                            <option value="">Todos los tipos</option>
                            <option value="alta">üöÄ Decisi√≥n R√°pida</option>
                            <option value="media">‚è≥ Decisi√≥n Normal</option>
                            <option value="baja">ü§î Planifican Mucho</option>
                        </select>
                    </div>
                </div>

                <div class="view-controls">
                    <div class="view-toggle">
                        <button class="view-toggle-btn active" onclick="cambiarVista('cards')" id="cardsViewBtn">üìã Tarjetas</button>
                        <button class="view-toggle-btn" onclick="cambiarVista('list')" id="listViewBtn">üìÉ Lista</button>
                    </div>
                    <div class="flex" style="gap: 8px;">
                        <button class="btn btn-warning" onclick="exportarPerfiles()">üìä CSV</button>
                        <button class="btn btn-primary" onclick="exportarJSON()">üíæ Backup</button>
                        <button class="btn btn-success" onclick="compartirPerfiles()">üì§ Compartir</button>
                    </div>
                </div>
                
                <div class="formulario-cliente" id="formularioCliente" style="display: none;">
                    <div class="flex-between" style="margin-bottom: 15px; padding-bottom: 10px; border-bottom: 2px solid var(--border);">
                        <h4 id="tituloFormulario">‚ûï Agregar Nuevo Perfil</h4>
                        <button class="btn btn-danger" onclick="cerrarFormularioCliente()">‚úñÔ∏è</button>
                    </div>
                    <form id="clienteForm">
                        <input type="hidden" id="clienteId">
                        <div class="grid" style="grid-template-columns: 1fr; gap: 12px;">
                            <div class="form-group">
                                <label>Nombre del Perfil/Arquetipo</label>
                                <input type="text" id="clienteNombre" required placeholder="Ej: Restaurante Familiar Exitoso">
                            </div>
                            <div class="form-group">
                                <label>Tipo de Negocio</label>
                                <select id="clienteTipo" required>
                                    <option value="">Seleccionar tipo</option>
                                    <option value="restaurante">Restaurante/Bar</option>
                                    <option value="retail">Tienda/Retail</option>
                                    <option value="servicios">Servicios Profesionales</option>
                                    <option value="clinica">Cl√≠nica/Consultorio</option>
                                    <option value="empresa">Empresa/Corporativo</option>
                                    <option value="otro">Otro</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Caracter√≠sticas IDEALES</label>
                                <textarea id="clienteCaracteristicas" required placeholder="Caracter√≠sticas que los hacen clientes ideales..."></textarea>
                            </div>
                            <div class="form-group">
                                <label>Publicidad que necesitan</label>
                                <textarea id="clienteNecesidad" required placeholder="Tipo de publicidad que t√≠picamente requieren..."></textarea>
                            </div>
                        </div>
                        <div class="flex" style="gap: 8px; justify-content: flex-end; margin-top: 15px; padding-top: 12px; border-top: 1px solid var(--border);">
                            <button type="submit" class="btn btn-success">üíæ Guardar</button>
                            <button type="button" class="btn btn-danger" onclick="cerrarFormularioCliente()">‚ùå Cancelar</button>
                        </div>
                    </form>
                </div>
                
                <div id="perfilesCount" style="text-align: center; margin-bottom: 15px; font-weight: 600; color: var(--primary);">üìä Cargando perfiles...</div>
                <div id="clientesPotencialesList" class="grid">
                    <div class="loading">Cargando perfiles de clientes ideales...</div>
                </div>
            </div>
        </div>

        <div class="admin-mode hidden" id="adminMode">
            <!-- El contenido admin se genera din√°micamente -->
        </div>
    </div>

    <script>
        // üåê CONFIGURACI√ìN
        const API_BASE_URL = 'https://scripts-ventas-dpi.up.railway.app';
        
        // üìä ESTADO GLOBAL
        const STATE = {
            scripts: {},
            clientes: [],
            currentEditingId: null,
            currentEditingClienteId: null,
            currentView: 'cards',
            isAuthenticated: false,
            debounceTimer: null,
            searchController: null
        };

        // üé® TEMPLATES
        const TEMPLATES = {
            semaforoLight: (color, data) => `
                <div class="semaforo-light ${color}" onclick="handleSemaforoClick('${color}')">
                    <div class="semaforo-icon">${data.icon}</div>
                    <div>
                        <div class="semaforo-title">${data.title}</div>
                        <div class="semaforo-description">${data.description}</div>
                        <ul class="semaforo-list">
                            ${data.items.map(item => `<li>${item}</li>`).join('')}
                        </ul>
                    </div>
                </div>
            `,
            
            etapa: (num, title, tiempo, data) => `
                <div class="etapa">
                    <div class="etapa-header">
                        <span class="etapa-numero">${num}</span>
                        <h3>${title}</h3>
                        <span class="etapa-tiempo">${tiempo}</span>
                    </div>
                    <div class="etapa-content">
                        <div style="background: rgba(15, 167, 149, 0.1); padding: 10px; border-radius: 6px; border-left: 3px solid var(--primary); margin-bottom: 12px;">
                            <strong>Objetivo:</strong> ${data.objetivo}
                        </div>
                        ${data.preguntas ? `
                            <div style="background: rgba(255, 193, 7, 0.1); padding: 10px; border-radius: 6px; border-left: 3px solid var(--warning); margin-bottom: 12px;">
                                <strong>Preguntas:</strong>
                                <ul style="margin: 8px 0 0 16px;">
                                    ${data.preguntas.map(p => `<li style="margin: 4px 0; font-style: italic; font-size: 0.85em;">${p}</li>`).join('')}
                                </ul>
                            </div>
                        ` : ''}
                        ${data.button ? `<button class="btn btn-primary" onclick="irACategoria('${data.category}')">${data.button}</button>` : ''}
                    </div>
                </div>
            `,
            
            scriptCard: (script) => {
                const badge = script.badge ? `<span class="script-badge" style="background: ${script.badge.color}">${script.badge.icon} ${script.badge.text}</span>` : '';
                return `
                    <div class="script-card" data-script-id="${script.id}">
                        <div class="script-title">
                            ${script.title}
                            ${badge}
                        </div>
                        <div class="script-text">${script.text}</div>
                        <div style="font-size: 0.7em; color: #7f8c8d; margin: 8px 0;">
                            üìä ${script.usage_30_days || 0} usos ‚Ä¢ üìà ${script.usage_7_days || 0} (7d)
                        </div>
                        <button class="copy-btn" onclick="copyAndTrack(${script.id})">üìã Copiar</button>
                    </div>
                `;
            },
            
            perfilCard: (cliente) => {
                const tipos = {restaurante: "üçΩÔ∏è Restaurante", retail: "üè™ Retail", servicios: "üíº Servicios", clinica: "üè• Cl√≠nica", empresa: "üè¢ Empresa", otro: "üìã Otro"};
                const presupuestos = {bajo: "Bajo", medio: "Medio", alto: "Alto"};
                const urgencias = {baja: "Planifican", media: "Normal", alta: "R√°pidos"};
                
                return `
                    <div class="perfil-card-enhanced">
                        <div class="flex-between" style="margin-bottom: 15px;">
                            <div style="font-weight: 700; font-size: 1.2em;">${cliente.nombre}</div>
                            <div class="flex" style="flex-direction: column; gap: 6px; align-items: flex-end;">
                                <span class="badge-smart badge-tipo">${tipos[cliente.tipo] || cliente.tipo}</span>
                                ${cliente.presupuesto ? `<span class="badge-smart badge-presupuesto ${cliente.presupuesto}">${presupuestos[cliente.presupuesto]}</span>` : ''}
                                ${cliente.urgencia ? `<span class="badge-smart badge-urgencia ${cliente.urgencia}">${urgencias[cliente.urgencia]}</span>` : ''}
                            </div>
                        </div>
                        <div style="background: var(--bg); padding: 12px; border-radius: 8px; border-left: 3px solid var(--primary); margin-bottom: 15px;">
                            <strong>üéØ Caracter√≠sticas:</strong><br>
                            <span>${cliente.caracteristicas.length > 150 ? cliente.caracteristicas.substring(0, 150) + '...' : cliente.caracteristicas}</span>
                        </div>
                        <div class="flex-between" style="margin-top: 15px; padding-top: 15px; border-top: 1px solid var(--border);">
                            <div style="font-size: 0.75em; color: #7f8c8d;">
                                üìù ${cliente.vendedor || 'No especificado'} ‚Ä¢ üìÖ ${cliente.fecha ? new Date(cliente.fecha).toLocaleDateString() : 'Sin fecha'}
                            </div>
                            <div class="flex" style="gap: 6px;">
                                <button class="btn" style="background: var(--info); color: white; padding: 4px 8px; font-size: 0.7em;" onclick="copiarPerfil(${cliente.id})">üìã</button>
                                <button class="btn" style="background: var(--warning); color: white; padding: 4px 8px; font-size: 0.7em;" onclick="editarCliente(${cliente.id})">‚úèÔ∏è</button>
                                <button class="btn" style="background: var(--danger); color: white; padding: 4px 8px; font-size: 0.7em;" onclick="eliminarCliente(${cliente.id})">üóëÔ∏è</button>
                            </div>
                        </div>
                    </div>
                `;
            }
        };

        // üîß UTILIDADES
        const utils = {
            showAlert(message, type = 'success') {
                const alertEl = document.createElement('div');
                alertEl.className = `alert ${type}`;
                alertEl.textContent = message;
                document.getElementById('mainContent').prepend(alertEl);
                setTimeout(() => alertEl.remove(), 4000);
            },

            async apiCall(endpoint, options = {}) {
                try {
                    const response = await fetch(`${API_BASE_URL}${endpoint}`, {
                        ...options,
                        headers: { 'Content-Type': 'application/json', ...options.headers }
                    });
                    
                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({ error: `Error HTTP: ${response.status}` }));
                        throw new Error(errorData.error || `Error HTTP: ${response.status}`);
                    }
                    
                    return await response.json();
                } catch (error) {
                    utils.showAlert(`Error de conexi√≥n: ${error.message}`, 'error');
                    throw error;
                }
            },

            updateConnectionStatus(isOnline) {
                const statusEl = document.getElementById('connectionStatus');
                statusEl.textContent = isOnline ? 'üü¢ En l√≠nea' : 'üî¥ Sin conexi√≥n';
                statusEl.className = `connection-status ${isOnline ? 'online' : 'offline'}`;
            },

            updateSystemStatus() {
                const totalCount = Object.values(STATE.scripts).reduce((sum, cat) => sum + (Array.isArray(cat) ? cat.length : 0), 0);
                const statusEl = document.getElementById('systemStatus');
                statusEl.className = 'status online';
                statusEl.innerHTML = `‚úÖ Sistema activo - ${totalCount} scripts disponibles - ${new Date().toLocaleTimeString()}`;
            }
        };

        // üìä DATA MANAGEMENT
        const dataManager = {
            async loadScripts() {
                try {
                    const data = await utils.apiCall('/api/scripts');
                    STATE.scripts = data;
                    this.renderScripts();
                    utils.updateSystemStatus();
                } catch (error) {
                    document.getElementById('scriptsContainer').innerHTML = `<div class="error-message">‚ùå Error al cargar scripts: ${error.message}</div>`;
                }
            },

            async loadClientes() {
                try {
                    const data = await utils.apiCall('/api/clientes-potenciales');
                    STATE.clientes = data;
                    this.renderClientes();
                } catch (error) {
                    document.getElementById('clientesPotencialesList').innerHTML = `<div class="error-message">‚ùå Error al cargar perfiles: ${error.message}</div>`;
                }
            },

            renderScripts() {
                const tabsContainer = document.getElementById('categoryTabs');
                const scriptsContainer = document.getElementById('scriptsContainer');
                
                tabsContainer.innerHTML = '';
                scriptsContainer.innerHTML = '';
                
                const categories = {
                    bienvenida: "üí¨ Bienvenida", 
                    calificacion: "üîç Calificaci√≥n", 
                    objeciones: "üõ°Ô∏è Objeciones", 
                    seguimiento: "üìû Seguimiento", 
                    cierre: "üéØ Cierre"
                };
                
                Object.keys(categories).forEach((category, index) => {
                    const tab = document.createElement('button');
                    tab.className = `tab ${index === 0 ? 'active' : ''}`;
                    tab.textContent = categories[category];
                    tab.onclick = (e) => uiManager.showTab(category, e.target);
                    tabsContainer.appendChild(tab);
                    
                    const section = document.createElement('div');
                    section.id = category;
                    section.className = `tab-section ${index > 0 ? 'hidden' : ''}`;
                    
                    if (STATE.scripts[category] && STATE.scripts[category].length > 0) {
                        section.innerHTML = `<div class="scripts-grid">${STATE.scripts[category].map(TEMPLATES.scriptCard).join('')}</div>`;
                    } else {
                        section.innerHTML = `<div class="empty-state">No hay scripts en esta categor√≠a.</div>`;
                    }
                    
                    scriptsContainer.appendChild(section);
                });
            },

            renderClientes() {
                const container = document.getElementById('clientesPotencialesList');
                const perfilesFiltrados = this.filtrarClientes();
                
                document.getElementById('perfilesCount').textContent = `üìä ${perfilesFiltrados.length} perfil${perfilesFiltrados.length !== 1 ? 'es' : ''} encontrado${perfilesFiltrados.length !== 1 ? 's' : ''}`;
                
                if (perfilesFiltrados.length === 0) {
                    container.innerHTML = `<div class="empty-state">üìö No hay perfiles que coincidan con los filtros.</div>`;
                    return;
                }
                
                container.innerHTML = perfilesFiltrados.map(TEMPLATES.perfilCard).join('');
            },

            filtrarClientes() {
                const filtroTipo = document.getElementById('filtroTipo')?.value || '';
                const filtroPresupuesto = document.getElementById('filtroPresupuesto')?.value || '';
                const filtroUrgencia = document.getElementById('filtroUrgencia')?.value || '';
                
                return STATE.clientes.filter(cliente => {
                    return (!filtroTipo || cliente.tipo === filtroTipo) &&
                           (!filtroPresupuesto || cliente.presupuesto === filtroPresupuesto) &&
                           (!filtroUrgencia || cliente.urgencia === filtroUrgencia);
                });
            }
        };

        // üéõÔ∏è UI MANAGEMENT
        const uiManager = {
            initSemaforo() {
                const semaforoData = {
                    verde: { icon: 'üü¢', title: 'LUZ VERDE: COTIZAR', description: 'El cliente se siente escuchado, conf√≠a en nosotros y entiende el valor.', items: ['Entendimos su "porqu√©"', 'Validamos su presupuesto', 'Confirm√≥ que le gusta la idea', 'El decisor est√° involucrado'] },
                    amarillo: { icon: 'üü°', title: 'LUZ AMARILLA: INVESTIGAR', description: 'A√∫n no entendemos la necesidad real. Es momento de preguntar, no de proponer.', items: ['Habla solo de precio', 'No tiene claro el objetivo', 'Pide "ideas" sin contexto', 'No es el decisor final'] },
                    rojo: { icon: 'üî¥', title: 'LUZ ROJA: PAUSAR', description: 'Riesgo alto de ser una "cotizaci√≥n fantasma". Invertir tiempo aqu√≠ es costoso.', items: ['"Solo para tener una idea"', 'Sin presupuesto ni urgencia', 'No responde preguntas clave', '"Env√≠eme lo que tengas"'] }
                };
                
                document.getElementById('semaforoContainer').innerHTML = Object.entries(semaforoData).map(([color, data]) => TEMPLATES.semaforoLight(color, data)).join('');
            },

            initProceso() {
                const etapasData = [
                    { num: 1, title: 'üé¨ Apertura & Rapport', tiempo: '2-3 min', data: { objetivo: 'Generar confianza y entender la situaci√≥n general', preguntas: ['"¬øC√≥mo nos conociste?"', '"¬øQu√© te lleva a buscar publicidad en este momento?"'], button: 'üìù Ver Scripts de Apertura', category: 'bienvenida' } },
                    { num: 2, title: 'üîç Investigaci√≥n & Necesidad', tiempo: '5-7 min', data: { objetivo: 'Entender el PORQU√â real detr√°s de su necesidad', preguntas: ['"¬øQu√© quieres lograr con esta publicidad?"', '"¬øQu√© pasar√≠a si no haces nada?"'], button: 'üîç Ver Scripts de Investigaci√≥n', category: 'calificacion' } },
                    { num: 3, title: 'üí∞ Presupuesto & Decisi√≥n', tiempo: '3-5 min', data: { objetivo: 'Validar presupuesto real y proceso de decisi√≥n', preguntas: ['"¬øTienes presupuesto definido para esto?"', '"¬øEres t√∫ quien autoriza la inversi√≥n?"'], button: 'üí∞ Ver Scripts de Presupuesto', category: 'calificacion' } },
                    { num: 4, title: 'üéØ Evaluaci√≥n & Pr√≥ximos Pasos', tiempo: '2-3 min', data: { objetivo: 'Tomar decisi√≥n final basada en la informaci√≥n recabada' } }
                ];
                
                document.getElementById('etapasContainer').innerHTML = etapasData.map(etapa => TEMPLATES.etapa(etapa.num, etapa.title, etapa.tiempo, etapa.data)).join('');
            },

            showTab(category, clickedTab) {
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-section').forEach(s => s.classList.add('hidden'));
                
                if (clickedTab) clickedTab.classList.add('active');
                
                const section = document.getElementById(category);
                if (section) section.classList.remove('hidden');
            }
        };

        // üé¨ EVENT HANDLERS
        async function copyAndTrack(scriptId) {
            const card = document.querySelector(`.script-card[data-script-id="${scriptId}"]`);
            const textElement = card.querySelector('.script-text');
            const button = card.querySelector('.copy-btn');
            
            try {
                await navigator.clipboard.writeText(textElement.innerText);
                
                const originalText = button.textContent;
                button.textContent = '‚úÖ Copiado';
                button.classList.add('copied');
                
                setTimeout(() => {
                    button.textContent = originalText;
                    button.classList.remove('copied');
                }, 2000);
                
                await utils.apiCall(`/api/scripts/${scriptId}/track`, { method: 'POST' });
            } catch (error) {
                utils.showAlert('Error al copiar al portapapeles', 'error');
            }
        }

        function handleSemaforoClick(color) {
            const categoryMap = { verde: 'cierre', amarillo: 'calificacion', rojo: 'bienvenida' };
            const messages = {
                verde: 'üü¢ Cliente LISTO para cotizar ‚Üí Ir a scripts de CIERRE',
                amarillo: 'üü° Cliente necesita INVESTIGACI√ìN ‚Üí Ir a scripts de CALIFICACI√ìN', 
                rojo: 'üî¥ Cliente PROBLEM√ÅTICO ‚Üí Usar scripts b√°sicos de BIENVENIDA'
            };
            
            utils.showAlert(messages[color], 'success');
            
            setTimeout(() => {
                const tabs = Array.from(document.querySelectorAll('.tab'));
                const targetTab = tabs.find(tab => tab.textContent.toLowerCase().includes(categoryMap[color]));
                if (targetTab) {
                    uiManager.showTab(categoryMap[color], targetTab);
                    setTimeout(() => document.getElementById('categoryTabs').scrollIntoView({ behavior: 'smooth' }), 100);
                }
            }, 1500);
        }

        function iniciarProceso() {
            document.getElementById('procesoPanel').style.display = 'block';
            setTimeout(() => document.getElementById('procesoPanel').scrollIntoView({ behavior: 'smooth' }), 100);
            utils.showAlert('üéØ Proceso de calificaci√≥n iniciado', 'success');
        }

        function cerrarProceso() {
            document.getElementById('procesoPanel').style.display = 'none';
            utils.showAlert('üìã Proceso cerrado', 'success');
        }

        function irACategoria(categoria) {
            cerrarProceso();
            const tabs = Array.from(document.querySelectorAll('.tab'));
            const targetTab = tabs.find(tab => tab.textContent.toLowerCase().includes(categoria));
            if (targetTab) {
                uiManager.showTab(categoria, targetTab);
                setTimeout(() => document.getElementById('categoryTabs').scrollIntoView({ behavior: 'smooth' }), 100);
            }
        }

        // üîê AUTH
        function switchMode(mode) {
            if (mode === 'admin' && !STATE.isAuthenticated) {
                document.getElementById('authOverlay').classList.add('active');
                document.getElementById('mainContent').style.filter = 'blur(5px)';
                return;
            }
            
            document.querySelectorAll('.mode-btn').forEach(btn => btn.classList.remove('active'));
            
            if (mode === 'ventas') {
                document.getElementById('ventasMode').style.display = 'block';
                document.getElementById('adminMode').classList.add('hidden');
                document.getElementById('ventasModeBtn').classList.add('active');
            } else {
                document.getElementById('ventasMode').style.display = 'none';
                document.getElementById('adminMode').classList.remove('hidden');
                document.getElementById('adminModeBtn').classList.add('active');
                loadAdminMode();
            }
        }

        function handleAuth(e) {
            e.preventDefault();
            const username = document.getElementById('authUsername').value;
            const password = document.getElementById('authPassword').value;
            
            if (username === 'admin' && password === 'DPI2025Admin') {
                STATE.isAuthenticated = true;
                document.getElementById('authOverlay').classList.remove('active');
                document.getElementById('mainContent').style.filter = 'none';
                switchMode('admin');
                utils.showAlert('‚úÖ Acceso administrativo concedido', 'success');
            } else {
                document.getElementById('authError').style.display = 'block';
            }
        }

        function cancelAuth() {
            document.getElementById('authOverlay').classList.remove('active');
            document.getElementById('mainContent').style.filter = 'none';
        }

        // üë§ CLIENTE FUNCTIONS
        function filtrarPerfiles() {
            dataManager.renderClientes();
        }

        function abrirFormularioCliente() {
            document.getElementById('formularioCliente').style.display = 'block';
            document.getElementById('clienteForm').reset();
            STATE.currentEditingClienteId = null;
        }

        function cerrarFormularioCliente() {
            document.getElementById('formularioCliente').style.display = 'none';
        }

        function cambiarVista(vista) {
            STATE.currentView = vista;
            document.querySelectorAll('.view-toggle-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById(`${vista}ViewBtn`).classList.add('active');
            // Aqu√≠ ir√≠a la l√≥gica para cambiar entre vista de tarjetas y lista
        }

        async function editarCliente(id) {
            const cliente = STATE.clientes.find(c => c.id === id);
            if (!cliente) return;
            
            STATE.currentEditingClienteId = id;
            document.getElementById('clienteNombre').value = cliente.nombre;
            document.getElementById('clienteTipo').value = cliente.tipo;
            document.getElementById('clienteCaracteristicas').value = cliente.caracteristicas;
            document.getElementById('clienteNecesidad').value = cliente.necesidad;
            document.getElementById('tituloFormulario').textContent = `‚úèÔ∏è Editando: ${cliente.nombre}`;
            document.getElementById('formularioCliente').style.display = 'block';
        }

        async function eliminarCliente(id) {
            const cliente = STATE.clientes.find(c => c.id === id);
            if (!cliente || !confirm(`¬øEliminar "${cliente.nombre}"?`)) return;
            
            try {
                await utils.apiCall(`/api/clientes-potenciales/${id}`, { 
                    method: 'DELETE',
                    headers: { 'Authorization': 'Bearer DPI2025Admin' } 
                });
                await dataManager.loadClientes();
                utils.showAlert('Cliente eliminado exitosamente', 'success');
            } catch (error) {
                utils.showAlert(`Error al eliminar: ${error.message}`, 'error');
            }
        }

        function copiarPerfil(id) {
            const cliente = STATE.clientes.find(c => c.id === id);
            if (!cliente) return;
            
            const texto = `üéØ PERFIL: ${cliente.nombre}\nüè¢ ${cliente.tipo}\nüéØ ${cliente.caracteristicas}\nüì¢ ${cliente.necesidad}`;
            navigator.clipboard.writeText(texto).then(() => {
                utils.showAlert('‚úÖ Perfil copiado', 'success');
            });
        }

        function exportarPerfiles() {
            const perfiles = dataManager.filtrarClientes();
            if (perfiles.length === 0) return utils.showAlert('‚ùå No hay perfiles para exportar', 'error');
            
            let csv = "Nombre,Tipo,Caracter√≠sticas,Necesidad\n";
            perfiles.forEach(p => {
                csv += `"${p.nombre}","${p.tipo}","${p.caracteristicas}","${p.necesidad}"\n`;
            });
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `perfiles_${new Date().toISOString().split('T')[0]}.csv`;
            link.click();
            
            utils.showAlert(`üìä ${perfiles.length} perfiles exportados`, 'success');
        }

        function exportarJSON() {
            const perfiles = dataManager.filtrarClientes();
            if (perfiles.length === 0) return utils.showAlert('‚ùå No hay perfiles para exportar', 'error');
            
            const blob = new Blob([JSON.stringify(perfiles, null, 2)], { type: 'application/json' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `backup_perfiles_${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            
            utils.showAlert(`üíæ ${perfiles.length} perfiles exportados en JSON`, 'success');
        }

        function compartirPerfiles() {
            const perfiles = dataManager.filtrarClientes();
            if (perfiles.length === 0) return utils.showAlert('‚ùå No hay perfiles para compartir', 'error');
            
            const resumen = `üéØ PERFILES DPI\nüìä ${perfiles.length} perfiles\n${perfiles.map((p, i) => `${i+1}. ${p.nombre} (${p.tipo})`).join('\n')}`;
            
            if (navigator.share) {
                navigator.share({ title: 'Perfiles DPI', text: resumen });
            } else {
                navigator.clipboard.writeText(resumen);
                utils.showAlert('üìã Resumen copiado', 'success');
            }
        }

        // üîß ADMIN
        function loadAdminMode() {
            document.getElementById('adminMode').innerHTML = `
                <div class="panel">
                    <h2>‚öôÔ∏è Panel de Administraci√≥n</h2>
                    <div class="admin-controls">
                        <div class="panel">
                            <h3>‚ûï Agregar Script</h3>
                            <form id="adminScriptForm">
                                <div class="form-group">
                                    <label>Categor√≠a</label>
                                    <select id="adminCategory" required>
                                        <option value="">Seleccionar</option>
                                        <option value="bienvenida">üí¨ Bienvenida</option>
                                        <option value="calificacion">üîç Calificaci√≥n</option>
                                        <option value="objeciones">üõ°Ô∏è Objeciones</option>
                                        <option value="seguimiento">üìû Seguimiento</option>
                                        <option value="cierre">üéØ Cierre</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>T√≠tulo</label>
                                    <input type="text" id="adminTitle" required>
                                </div>
                                <div class="form-group">
                                    <label>Texto</label>
                                    <textarea id="adminText" required></textarea>
                                </div>
                                <button type="submit" class="btn btn-success">üíæ Guardar Script</button>
                            </form>
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('adminScriptForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                const category = document.getElementById('adminCategory').value;
                const title = document.getElementById('adminTitle').value;
                const text = document.getElementById('adminText').value;
                
                try {
                    await utils.apiCall('/api/scripts', {
                        method: 'POST',
                        headers: { 'Authorization': 'Bearer DPI2025Admin' },
                        body: JSON.stringify({ category, title, text })
                    });
                    
                    utils.showAlert('‚úÖ Script creado exitosamente', 'success');
                    e.target.reset();
                    await dataManager.loadScripts();
                } catch (error) {
                    utils.showAlert(`‚ùå Error: ${error.message}`, 'error');
                }
            });
        }

        // üöÄ INICIALIZACI√ìN
        document.addEventListener('DOMContentLoaded', () => {
            console.log('üöÄ Iniciando DPI Sistema Optimizado...');
            
            // Event listeners
            document.getElementById('authForm').addEventListener('submit', handleAuth);
            
            const searchInput = document.getElementById('searchInput');
            searchInput.addEventListener('input', (e) => {
                clearTimeout(STATE.debounceTimer);
                STATE.debounceTimer = setTimeout(() => {
                    const query = e.target.value.trim();
                    if (query.length > 1) {
                        // B√∫squeda simple local
                        const results = [];
                        Object.entries(STATE.scripts).forEach(([category, scripts]) => {
                            scripts.forEach(script => {
                                if (script.title.toLowerCase().includes(query.toLowerCase()) || 
                                    script.text.toLowerCase().includes(query.toLowerCase())) {
                                    results.push({...script, category});
                                }
                            });
                        });
                        
                        const searchResults = document.getElementById('searchResults');
                        if (results.length > 0) {
                            searchResults.innerHTML = results.map(r => `
                                <div class="search-result-item" onclick="scrollToScript(${r.id})">
                                    <div class="search-result-category">${r.category}</div>
                                    <div>${r.title}</div>
                                </div>
                            `).join('');
                            searchResults.classList.add('active');
                        }
                    } else {
                        document.getElementById('searchResults').classList.remove('active');
                    }
                }, 300);
            });

            document.getElementById('clienteForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                const clienteData = {
                    nombre: document.getElementById('clienteNombre').value.trim(),
                    tipo: document.getElementById('clienteTipo').value,
                    caracteristicas: document.getElementById('clienteCaracteristicas').value.trim(),
                    necesidad: document.getElementById('clienteNecesidad').value.trim()
                };
                
                try {
                    const endpoint = STATE.currentEditingClienteId ? 
                        `/api/clientes-potenciales/${STATE.currentEditingClienteId}` : 
                        '/api/clientes-potenciales';
                    const method = STATE.currentEditingClienteId ? 'PUT' : 'POST';
                    
                    await utils.apiCall(endpoint, {
                        method,
                        headers: { 'Authorization': 'Bearer DPI2025Admin' },
                        body: JSON.stringify(clienteData)
                    });
                    
                    utils.showAlert('‚úÖ Perfil guardado exitosamente', 'success');
                    cerrarFormularioCliente();
                    await dataManager.loadClientes();
                } catch (error) {
                    utils.showAlert(`‚ùå Error: ${error.message}`, 'error');
                }
            });
            
            // Inicializar componentes
            uiManager.initSemaforo();
            uiManager.initProceso();
            
            // Cargar datos
            dataManager.loadScripts();
            dataManager.loadClientes();
            
            // Conexi√≥n monitoring
            setInterval(() => utils.updateConnectionStatus(navigator.onLine), 10000);
            
            console.log('‚úÖ Sistema optimizado inicializado');
        });

        // Hacer funciones globales disponibles
        window.switchMode = switchMode;
        window.handleAuth = handleAuth;
        window.cancelAuth = cancelAuth;
        window.copyAndTrack = copyAndTrack;
        window.handleSemaforoClick = handleSemaforoClick;
        window.iniciarProceso = iniciarProceso;
        window.cerrarProceso = cerrarProceso;
        window.irACategoria = irACategoria;
        window.filtrarPerfiles = filtrarPerfiles;
        window.abrirFormularioCliente = abrirFormularioCliente;
        window.cerrarFormularioCliente = cerrarFormularioCliente;
        window.cambiarVista = cambiarVista;
        window.editarCliente = editarCliente;
        window.eliminarCliente = eliminarCliente;
        window.copiarPerfil = copiarPerfil;
        window.exportarPerfiles = exportarPerfiles;
        window.exportarJSON = exportarJSON;
        window.compartirPerfiles = compartirPerfiles;
    </script>
</body>
</html>
